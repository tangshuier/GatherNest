{% extends "base.html" %}

{% block content %}
<style>
    /* 基础样式优化 */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
    }
    
    /* 统计卡片样式 */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .stat-card h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
        color: #666;
        font-weight: normal;
    }
    .stat-card .value {
        font-size: 28px;
        font-weight: bold;
        margin: 0;
    }
    .stat-card.total {
        border-left: 4px solid #007bff;
    }
    .stat-card.completed {
        border-left: 4px solid #28a745;
    }
    .stat-card.in-progress {
        border-left: 4px solid #ffc107;
    }
    .stat-card.engineers {
        border-left: 4px solid #17a2b8;
    }
    
    /* 表格样式优化 */
    .table-container {
        width: 100%;
        overflow-x: auto;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .data-table {
        width: 100%;
        min-width: 900px; /* 确保表格在小屏幕上可以水平滚动 */
        border-collapse: collapse;
        background-color: white;
    }
    .data-table th, .data-table td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #e9ecef;
        max-width: 200px;
        min-height: 50px;
        word-break: break-word;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
    }
    /* 特定列的宽度调整 */
    .data-table th:first-child, .data-table td:first-child {
        max-width: 50px;
        text-align: center;
    }
    .data-table th:nth-child(2), .data-table td:nth-child(2) {
        max-width: 80px;
    }
    .data-table th:nth-child(3), .data-table td:nth-child(3) {
        max-width: 150px;
    }
    .data-table th:nth-child(4), .data-table td:nth-child(4) {
        max-width: 250px;
    }
    .data-table th:last-child, .data-table td:last-child {
        max-width: 120px;
        white-space: nowrap;
    }
    .data-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    .data-table th:hover {
        background-color: #e9ecef;
    }
    .data-table th.sortable::after {
        content: ' ▼';
        font-size: 10px;
        color: #6c757d;
        margin-left: 5px;
    }
    .data-table th.sortable.asc::after {
        content: ' ▲';
        color: #007bff;
    }
    .data-table th.sortable.desc::after {
        content: ' ▼';
        color: #007bff;
    }
    .data-table tr:hover {
        background-color: #f8f9fa;
    }
    
    /* 状态徽章样式 */
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        display: inline-block;
    }
    .status-badge.critical { background-color: #fee; color: #dc3545; border: 1px solid #fcc; }
    .status-badge.warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .status-badge.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .status-badge.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    
    /* 搜索表单样式 */
    .search-form {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .search-form .form-group {
        flex: 1;
        min-width: 200px;
    }
    .search-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #495057;
    }
    .search-form .form-control {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 8px 12px;
        width: 100%;
        transition: border-color 0.15s ease-in-out;
    }
    .search-form .form-control:focus {
        border-color: #80bdff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    
    /* 分页样式 */
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    .pagination-info {
        margin-top: 10px;
        color: #6c757d;
        text-align: center;
    }
    
    /* 按钮样式优化 */
    .btn {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
        text-align: center;
    }
    .btn-add {
        background-color: #28a745;
        color: white;
    }
    .btn-add:hover {
        background-color: #218838;
        transform: translateY(-1px);
    }
    .btn-edit {
        background-color: #007bff;
        color: white;
        padding: 4px 8px;
        font-size: 12px;
    }
    .btn-edit:hover {
        background-color: #0056b3;
    }
    .btn-delete {
        background-color: #dc3545;
        color: white;
        padding: 4px 8px;
        font-size: 12px;
    }
    .btn-delete:hover {
        background-color: #c82333;
    }
    .btn-export {
        background-color: #17a2b8;
        color: white;
        margin-left: 10px;
    }
    .btn-export:hover {
        background-color: #138496;
        transform: translateY(-1px);
    }
    .btn-batch {
        background-color: #6c757d;
        color: white;
        margin-right: 10px;
    }
    .btn-batch:hover {
        background-color: #545b62;
    }
    
    /* 头部操作区域 */
    .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .header-actions-left, .header-actions-right {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    /* 空状态样式 */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    .empty-state p {
        font-size: 16px;
        margin-bottom: 20px;
    }
    
    /* 图片样式 */
    .thumbnail { 
        max-width: 80px; 
        max-height: 60px; 
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #ddd;
        transition: transform 0.2s;
    }
    .thumbnail:hover {
        transform: scale(1.05);
    }
    
    /* 批量操作区域 */
    .batch-actions {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        display: none;
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
        .stats-container {
            grid-template-columns: 1fr;
        }
        .header-actions {
            flex-direction: column;
            align-items: stretch;
        }
        .search-form {
            flex-direction: column;
        }
    }
</style>

<div class="container mt-4">
    <h2>项目管理</h2>
    
    <!-- 统计卡片区域 -->
    <div class="stats-container">
        <div class="stat-card total">
            <h3>总项目数</h3>
            <p class="value">{{ total_projects }}</p>
        </div>
        <div class="stat-card completed">
            <h3>已完成项目</h3>
            <p class="value">{{ completed_projects|default(0) }}</p>
        </div>
        <div class="stat-card in-progress">
            <h3>进行中项目</h3>
            <p class="value">{{ in_progress_projects|default(0) }}</p>
        </div>
        <div class="stat-card engineers">
            <h3>工程师人数</h3>
            <p class="value">{{ engineers|length }}</p>
        </div>
    </div>
    
    <!-- 批量操作区域 -->
    <div class="batch-actions" id="batchActions">
        <div class="header-actions-left">
            <span>已选择 <span id="selectedCount">0</span> 项</span>
            <button class="btn btn-batch" onclick="batchDelete()">批量删除</button>
            <button class="btn btn-batch" onclick="batchExport()">批量导出</button>
            <button class="btn btn-batch" onclick="cancelBatch()">取消</button>
        </div>
    </div>
    
    <!-- 头部操作区域 -->
    <div class="header-actions">
        <div class="header-actions-left">
            <a href="{{ url_for('project.projects_add') }}" class="btn btn-add">添加新项目</a>
            <button class="btn btn-batch" onclick="enableBatchMode()">批量操作</button>
        </div>
        <div class="header-actions-right">
            <a href="{{ url_for('project.export_projects', **request.args) }}" class="btn btn-export">导出项目数据</a>
        </div>
    </div>
    
    <!-- 搜索和筛选表单 -->
    <form method="get" action="{{ url_for('project.projects_management') }}" class="search-form">
        <div class="form-group">
            <label for="search">搜索项目名称或ID</label>
            <input type="text" id="search" name="search" value="{{ search_query }}" placeholder="输入项目名称或ID" class="form-control">
        </div>
        
        <div class="form-group">
            <label for="project_type">项目类型</label>
            <select id="project_type" name="project_type" class="form-control">
                <option value="custom" {% if project_type == 'custom' %}selected{% endif %}>定制项目</option>
                <option value="finished" {% if project_type == 'finished' %}selected{% endif %}>成品项目</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="engineer_id">负责人</label>
            <select id="engineer_id" name="engineer_id" class="form-control">
                <option value="" {% if not engineer_id %}selected{% endif %}>全部负责人</option>
                {% for engineer in engineers %}
                <option value="{{ engineer.id }}" {% if engineer_id == engineer.id|string %}selected{% endif %}>
                    {{ engineer.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="progress">进度状态</label>
            <select id="progress" name="progress" class="form-control">
                <option value="" {% if not progress %}selected{% endif %}>全部状态</option>
                <option value="无方案" {% if progress == '无方案' %}selected{% endif %}>无方案</option>
                <option value="需要方案" {% if progress == '需要方案' %}selected{% endif %}>需要方案</option>
                <option value="方案未确认" {% if progress == '方案未确认' %}selected{% endif %}>方案未确认</option>
                <option value="确认方案不制作" {% if progress == '确认方案不制作' %}selected{% endif %}>确认方案不制作</option>
                <option value="待制作" {% if progress == '待制作' %}selected{% endif %}>待制作</option>
                <option value="制作中" {% if progress == '制作中' %}selected{% endif %}>制作中</option>
                <option value="完成待确认" {% if progress == '完成待确认' %}selected{% endif %}>完成待确认</option>
                <option value="确认不发货" {% if progress == '确认不发货' %}selected{% endif %}>确认不发货</option>
                <option value="确认待发货" {% if progress == '确认待发货' %}selected{% endif %}>确认待发货</option>
                <option value="已完成" {% if progress == '已完成' %}selected{% endif %}>已完成</option>
                <option value="结单" {% if progress == '结单' %}selected{% endif %}>结单</option>
                <option value="售后修改" {% if progress == '售后修改' %}selected{% endif %}>售后修改</option>
            </select>
        </div>
        
        <div class="form-group" style="display: flex; align-items: flex-end;">
            <button type="submit" class="btn btn-primary" style="width: 100%;">搜索</button>
        </div>
    </form>
    
    <!-- 项目列表表格 -->
    <div class="table-container">
        <table class="data-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th class="sortable" data-sort-field="id">项目ID</th>
                <th class="sortable" data-sort-field="name">项目名称</th>
                <th>负责人</th>
                <th>进度</th>
                <th>标签</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% if projects %}
                {% for project in projects %}
                <tr>
                    <td><input type="checkbox" class="project-checkbox" data-id="{{ project.id }}"></td>
                    <td>{{ project.id }}</td>
                    <td>
                        <a href="{{ url_for('project.projects_add', edit=project.id) }}" style="color: #007bff; text-decoration: none;">
                            {{ project.name }}
                        </a>
                    </td>
                    <td>{{ project.assigned_engineer.name if project.assigned_engineer else '<span class="text-danger">未分配</span>' }}</td>
                    <td>
                        <span class="status-badge {% if project.progress in ['无方案', '需要方案'] %}critical{% elif project.progress in ['方案未确认', '确认方案不制作', '待制作'] %}warning{% elif project.progress in ['制作中', '完成待确认'] %}info{% elif project.progress in ['已完成', '结单'] %}success{% endif %}">
                            {{ project.progress or '未设置' }}
                        </span>
                    </td>
                    <td>
                        {% if project.tags %}
                            {% for tag in project.tags %}
                                <span class="badge badge-info mr-1">{{ tag.name }}</span>
                            {% endfor %}
                        {% else %}
                            无
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm mr-1 view-project-details" data-project-id="{{ project.id }}">详细</button>
                            <a href="{{ url_for('project.projects_add', edit=project.id) }}" class="btn btn-edit">编辑</a>
                            <form method="post" action="{{ url_for('project.delete_project', project_id=project.id) }}" class="delete-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-delete" onclick="return confirm('确定要删除该项目吗？此操作不可撤销。');">删除</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="13" class="empty-state">
                        <p>暂无符合条件的项目记录</p>
                        <a href="{{ url_for('project.projects_add') }}" class="btn btn-add">添加第一个项目</a>
                    </td>
                </tr>
            {% endif %}
        </tbody>
        </table>
    </div>
    
    <!-- 分页控件 -->
    {% if total_projects > 0 %}
    <div class="pagination">
        <nav aria-label="项目分页">
            <ul class="pagination">
                {% if current_page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('project.projects_management', page=1, search=search_query, engineer_id=engineer_id, project_type=project_type, progress=progress, per_page=per_page) }}">首页</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('project.projects_management', page=current_page-1, search=search_query, engineer_id=engineer_id, project_type=project_type, progress=progress, per_page=per_page) }}">上一页</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">首页</span></li>
                <li class="page-item disabled"><span class="page-link">上一页</span></li>
                {% endif %}
                
                <!-- 页码显示 -->
                {% for page_num in range(1, total_pages + 1) %}
                    {% if page_num >= current_page - 2 and page_num <= current_page + 2 %}
                    <li class="page-item {% if page_num == current_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('project.projects_management', page=page_num, search=search_query, engineer_id=engineer_id, project_type=project_type, progress=progress, per_page=per_page) }}">{{ page_num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if current_page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('project.projects_management', page=current_page+1, search=search_query, engineer_id=engineer_id, project_type=project_type, progress=progress, per_page=per_page) }}">下一页</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('project.projects_management', page=total_pages, search=search_query, engineer_id=engineer_id, project_type=project_type, progress=progress, per_page=per_page) }}">末页</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">下一页</span></li>
                <li class="page-item disabled"><span class="page-link">末页</span></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    
    <!-- 分页信息 -->
    <div class="pagination-info text-center mt-2">
        共 {{ total_projects }} 个项目，当前第 {{ current_page }} / {{ total_pages }} 页
    </div>
    
    <!-- 每页显示数量选择器 -->
    <div class="page-size-selector text-center mt-2">
        <form action="{{ url_for('project.projects_management') }}" method="get" style="display: inline;">
            <input type="hidden" name="search" value="{{ search_query }}">
            <input type="hidden" name="engineer_id" value="{{ engineer_id }}">
            <input type="hidden" name="project_type" value="{{ project_type }}">
            <input type="hidden" name="progress" value="{{ progress }}">
            <label for="per_page">每页显示：</label>
            <select id="per_page" name="per_page" onchange="this.form.submit()">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
        </form>
    </div>
    {% endif %}
</div>

<!-- 图片查看模态框 -->
    <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">项目图片预览</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="关闭">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="项目图片" style="max-width: 100%; max-height: 70vh;">
                </div>
            </div>
        </div>
    </div>

    <!-- 项目详细信息模态框 -->
    <div class="modal fade" id="projectDetailsModal" tabindex="-1" role="dialog" aria-labelledby="projectDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="projectDetailsModalLabel">项目详细信息</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="关闭">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="projectDetailsContent">
                    <div class="loading-spinner" style="display: flex; justify-content: center; padding: 40px;">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">加载中...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // 显示图片预览
    function showImage(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
        }
        
        // 图片轮播功能
        $(document).ready(function() {
            let currentImageIndex = 0;
            let currentImageSet = [];
            
            $('.carousel-control-next').on('click', function() {
                if (currentImageSet.length > 0) {
                    currentImageIndex = (currentImageIndex + 1) % currentImageSet.length;
                    document.getElementById('modalImage').src = currentImageSet[currentImageIndex];
                }
            });
            
            $('.carousel-control-prev').on('click', function() {
                if (currentImageSet.length > 0) {
                    currentImageIndex = (currentImageIndex - 1 + currentImageSet.length) % currentImageSet.length;
                    document.getElementById('modalImage').src = currentImageSet[currentImageIndex];
                }
            });
        });

        // 确保函数在全局作用域中可用
        window.showProjectDetails = function(projectId) {
            const detailsContent = document.getElementById('projectDetailsContent');
            
            // 显示加载状态
            detailsContent.innerHTML = `
                <div class="loading-spinner" style="display: flex; justify-content: center; padding: 40px;">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">加载中...</span>
                    </div>
                </div>
            `;
            
            // 打开模态框
            $('#projectDetailsModal').modal('show');
            
            // 发送请求获取项目详情
            fetch(`/get_project_details/${projectId}`)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(function(project) {
                // 构建详细信息HTML
                var html = `
                        <div class="container-fluid">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h4 class="text-primary">${project.name}</h4>
                                    <p class="text-muted">项目ID: ${project.id}</p>
                                </div>
                                <div class="col-md-6 text-right">
                                    <span class="badge badge-info mr-2">创建时间: ${project.created_at || '未设置'}</span>
                                    <span class="badge badge-secondary">更新时间: ${project.updated_at || '未设置'}</span>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6 class="text-secondary">负责人</h6>
                                    <span>${project.engineer_name || '未分配'}</span>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-secondary">资料路径</h6>
                                    <span class="text-muted">${project.materials_path || '无'}</span>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-secondary">项目描述</h6>
                                    <div class="border rounded p-3 bg-light">
                                        ${project.description || '无'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 标签信息 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-secondary">项目标签</h6>
                                    <div class="mt-2">
                                        ${project.tags && project.tags.length > 0 ? 
                                            project.tags.map(function(tag) { return '<span class="badge badge-pill badge-primary mr-2">' + tag.name + '</span>'; }).join('') : 
                                            '<span class="text-muted">无标签</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                    `;
                    
                    // 添加文档信息
                    if (project.documents && project.documents.length > 0) {
                        html += `
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-secondary">文档资料</h6>
                                    <div class="border rounded p-3 bg-light">
                        `;
                        
                        // 分离文档和工程文件
                        var docFiles = project.documents.filter(function(doc) { return doc.type === 'document'; });
                        var engineeringFiles = project.documents.filter(function(doc) { return doc.type === 'engineering_zip'; });
                        var otherFiles = project.documents.filter(function(doc) { return doc.type !== 'document' && doc.type !== 'engineering_zip'; });
                        
                        if (docFiles.length > 0) {
                            html += `<h7 class="font-weight-bold mb-2 d-block">文档：</h7>`;
                            docFiles.forEach(function(doc) {
                                 html += `
                                <div class="mb-2">
                                    <a href="/document_viewer/view_document/${doc.id}" class="btn btn-sm btn-primary mr-1" target="_blank">
                                        查看文档
                                    </a>
                                    <a href="/project/download_document/${doc.id}" class="btn btn-sm btn-info mr-1" target="_blank">
                                        下载文档
                                    </a>
                                    <small class="text-muted">${doc.filename}</small>
                                </div>
                            `;
                             });
                        }
                        
                        if (engineeringFiles.length > 0) {
                            html += `<h7 class="font-weight-bold mb-2 d-block mt-3">工程文件：</h7>`;
                            engineeringFiles.forEach(function(doc) {
                                 html += `
                                <div class="mb-2">
                                    <a href="/document_viewer/view_document/${doc.id}" class="btn btn-sm btn-secondary mr-1" target="_blank">
                                        预览工程
                                    </a>
                                    <a href="/project/download_document/${doc.id}" class="btn btn-sm btn-info mr-1" target="_blank">
                                        下载工程
                                    </a>
                                    <small class="text-muted">${doc.filename}</small>
                                </div>
                            `;
                             });
                        }
                        
                        if (otherFiles.length > 0) {
                            html += `<h7 class="font-weight-bold mb-2 d-block mt-3">其他文件：</h7>`;
                            otherFiles.forEach(function(doc) {
                                 html += `
                                <div class="mb-2">
                                    <a href="/project/download_document/${doc.id}" class="btn btn-sm btn-info mr-1" target="_blank">
                                        下载
                                    </a>
                                    <small class="text-muted">${doc.filename}</small>
                                </div>
                            `;
                             });
                        }
                        
                        html += `
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 添加图片预览
                    if (project.images && project.images.length > 0) {
                        html += `
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-secondary">项目图片</h6>
                                    <div class="border rounded p-3 bg-light">
                                        <div class="row">
                        `;
                        
                        project.images.forEach(function(img) {
                            var imgPath = img.filepath.replace(/\\/g, '/');
                            html += `
                                <div class="col-md-4 mb-3">
                                    <div class="thumbnail-container border rounded overflow-hidden" style="cursor: pointer; height: 200px; display: flex; align-items: center; justify-content: center;">
                                        <img src="${imgPath}" alt="项目图片" class="img-thumbnail" style="max-height: 100%; max-width: 100%; object-fit: contain;" onclick="showImage('${imgPath}')" data-toggle="modal" data-target="#imageModal">
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 删除重复的标签渲染代码
                    
                    html += `</div>`;
                    
                    // 更新模态框内容
                    detailsContent.innerHTML = html;
                })
                .catch(function(error) {
                    detailsContent.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <strong>加载失败</strong> - 无法获取项目详情，请稍后重试。
                            <p class="mt-2">错误信息: ${error.message}</p>
                        </div>
                    `;
                });
        }
    
    // 为表单添加CSRF令牌
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('form');
        forms.forEach(function(form) {
            if (!form.querySelector('input[name="csrf_token"]')) {
                var tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
                tokenInput.value = '{{ csrf_token() }}';
                form.appendChild(tokenInput);
            }
        });
        
        // 添加项目详情按钮的事件委托处理
        document.addEventListener('click', function(event) {
            var target = event.target.closest('.view-project-details');
            if (target) {
                var projectId = parseInt(target.getAttribute('data-project-id'));
                if (typeof window.showProjectDetails === 'function') {
                    try {
                        window.showProjectDetails(projectId);
                    } catch (error) {
                        console.error('显示项目详情时出错:', error);
                        alert('无法显示项目详情，请稍后再试。');
                    }
                } else {
                    console.warn('项目详情函数不可用');
                    alert('项目详情功能暂不可用，请刷新页面后重试。');
                }
            }
        });
        
        // 全选/取消全选功能
        var selectAllCheckbox = document.getElementById('selectAll');
        var projectCheckboxes = document.querySelectorAll('.project-checkbox');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                projectCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = this.checked;
                });
                updateSelectedCount();
            });
        }
        
        projectCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                updateSelectedCount();
                // 检查是否所有项目都被选中
                var allChecked = Array.from(projectCheckboxes).every(function(cb) { return cb.checked; });
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = allChecked;
                }
            });
        });
    });
    
    // 更新已选择项目数量
    function updateSelectedCount() {
        var selectedCount = document.querySelectorAll('.project-checkbox:checked').length;
        document.getElementById('selectedCount').textContent = selectedCount;
    }
    
    // 启用批量操作模式
    function enableBatchMode() {
        document.getElementById('batchActions').style.display = 'block';
        // 滚动到批量操作区域
        document.getElementById('batchActions').scrollIntoView({ behavior: 'smooth' });
    }
    
    // 取消批量操作
    function cancelBatch() {
        document.getElementById('batchActions').style.display = 'none';
        document.querySelectorAll('.project-checkbox').forEach(function(checkbox) {
            checkbox.checked = false;
        });
        if (document.getElementById('selectAll')) {
            document.getElementById('selectAll').checked = false;
        }
    }
    
    // 批量删除
    function batchDelete() {
        var selectedProjects = Array.from(document.querySelectorAll('.project-checkbox:checked'))
            .map(function(checkbox) { return checkbox.getAttribute('data-id'); });
        
        if (selectedProjects.length === 0) {
            alert('请至少选择一个项目');
            return;
        }
        
        if (confirm('确定要删除选中的 ' + selectedProjects.length + ' 个项目吗？此操作不可撤销。')) {
            // 创建表单并提交
            var form = document.createElement('form');
            form.method = 'post';
            form.action = "/project/batch_delete"; // Direct URL path instead of template variable
            
            // 添加CSRF令牌
            var tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'csrf_token';
            tokenInput.value = '{{ csrf_token() }}';
            form.appendChild(tokenInput);
            
            // 添加选中的项目ID
            selectedProjects.forEach(function(projectId) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'project_ids';
                input.value = projectId;
                form.appendChild(input);
        });
            
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    // 批量导出
    function batchExport() {
        var selectedProjects = Array.from(document.querySelectorAll('.project-checkbox:checked'))
            .map(function(checkbox) { return checkbox.getAttribute('data-id'); });
        
        if (selectedProjects.length === 0) {
            alert('请至少选择一个项目');
            return;
        }
        
        // 构建导出URL
        var url = "{{ url_for('project.export_projects') }}" + '?';
        for (var index = 0; index < selectedProjects.length; index++) {
            var projectId = selectedProjects[index];
            url += 'project_ids=' + projectId;
            if (index < selectedProjects.length - 1) { url += '&'; }
        }
        
        window.location.href = url;
    }
    
    // 排序功能
    function sortBy(field) {
        // 获取当前排序方向
        var currentSort = new URLSearchParams(window.location.search).get('sort_by') || '';
        var direction = 'asc';
        
        if (currentSort === field) {
            // 如果点击的是当前排序字段，切换排序方向
            direction = new URLSearchParams(window.location.search).get('sort_direction') === 'asc' ? 'desc' : 'asc';
        }
        
        // 构建新的URL
        var urlParams = new URLSearchParams(window.location.search);
        urlParams.set('sort_by', field);
        urlParams.set('sort_direction', direction);
        
        // 保留其他查询参数
        window.location.search = urlParams.toString();
    }
    
    // 为排序表头添加事件监听
    document.addEventListener('click', function(event) {
        var sortableHeader = event.target.closest('th.sortable[data-sort-field]');
        if (sortableHeader) {
            var field = sortableHeader.getAttribute('data-sort-field');
            if (field) {
                sortBy(field);
            }
        }
    });
    
    // 初始化排序状态
    document.addEventListener('DOMContentLoaded', function() {
        var urlParams = new URLSearchParams(window.location.search);
        var sortByField = urlParams.get('sort_by');
        var sortDirection = urlParams.get('sort_direction') || 'asc';
        
        if (sortByField) {
            var sortableHeader = document.querySelector("th.sortable[data-sort-field='" + sortByField + "']");
            if (sortableHeader) {
                sortableHeader.classList.add(sortDirection);
            }
        }
    });
    
    // 添加项目详情按钮的事件委托监听器
    document.addEventListener('click', function(event) {
        var target = event.target.closest('.view-project-details');
        if (target) {
            var projectId = parseInt(target.getAttribute('data-project-id'));
            if (typeof window.showProjectDetails === 'function') {
                try {
                    window.showProjectDetails(projectId);
                } catch (error) {
                    console.error('显示项目详情时出错:', error);
                    alert('无法显示项目详情，请稍后再试。');
                }
            } else {
                console.warn('项目详情函数不可用');
                alert('项目详情功能暂不可用，请刷新页面后重试。');
            }
        }
    });
</script>

{% block scripts %}
<!-- 已移除重复的showProjectDetails函数定义，避免与project_utils.js中的同名函数冲突 -->
{% endblock %}