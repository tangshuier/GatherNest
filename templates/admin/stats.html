<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计分析 - 成品管理系统</title>
    <!-- 引入基础样式和字体图标（假设base.html中包含这些，这里保留继承关系） -->
    {% extends 'base.html' %}
</head>

<body>
    {% block title %}统计分析 - 成品管理系统{% endblock %}
    {% block page_title %}数据统计分析{% endblock %}

    {% block content %}
    <div class="section fade-in">
    <!-- 搜索区域 -->
    <div class="search-section">
        <h3>数据搜索</h3>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <form method="GET" action="/products">
                    <div class="form-group">
                        <label>搜索产品</label>
                        <input type="text" name="search" placeholder="按产品名称搜索..." 
                               value="{{ request.args.get('search', '') }}">
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-search"></i> 搜索产品
                    </button>
                </form>
            </div>
            
            <div style="flex: 1; min-width: 300px;">
                <!-- 搜索工程师表单 -->
                <form method="GET" action="/admin/engineer_projects" id="engineerSearchForm">
                    <div class="form-group">
                        <label>搜索工程师</label>
                        <div style="display: flex; gap: 10px;">
                            <select name="engineer_id" required style="flex: 1; max-height: 200px; overflow-y: auto;">
                                <option value="">-- 所有工程师 --</option>
                                {% for engineer in engineers %}
                                <option value="{{ engineer.id }}">{{ engineer.name }}</option>
                                {% endfor %}
                            </select>
                            <div style="flex: 1;">
                                <input type="text" name="engineer_id_manual" placeholder="手动输入工程师ID...">
                            </div>
                        </div>
                        <small class="form-text text-muted">提示：可以从下拉菜单选择或直接输入工程师ID</small>
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-user"></i> 查看分配产品
                    </button>
                </form>
            </div>
        </div>
    </div>

        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div class="chart-container"
                style="flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h3 style="margin-bottom: 15px; color: #1e40af;">产品状态分布</h3>
                <div id="productStatusContainer">
                    <canvas id="productStatusChart"></canvas>
                </div>
            </div>

            <div class="chart-container"
                style="flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h3 style="margin-bottom: 15px; color: #1e40af;">工程师任务分配</h3>
                <div id="engineerTaskContainer">
                    <canvas id="engineerTaskChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 图表数据容器 -->
    <div id="chart-data" style="display: none;" data-completed="{{ completed_count|default(0)|int }}"
        data-in-progress="{{ in_progress_count|default(0)|int }}"
        data-unassigned="{{ unassigned_count|default(0)|int }}" 
        data-engineer-names="{{ chart_data.engineer_names }}"
        data-task-counts="{{ chart_data.task_counts }}">
    </div>

    <!-- 直接引入本地Chart.js文件 -->
<script src="/static/js/chart.js" defer></script>

    <script>
        // 检查Chart是否已加载
        function checkChartLoaded() {
            const isLoaded = typeof Chart !== 'undefined';
            return isLoaded;
        }

        // 验证Chart对象有效性
        function validateChartObject() {
            if (typeof Chart !== 'undefined' && typeof Chart === 'function' && Chart.controllers) {
                return true;
            }
            return false;
        }

        // 初始化图表
        function initCharts() {
            const chartDataEl = document.getElementById('chart-data');
            if (!chartDataEl) {
                return;
            }

            // 解析产品状态数据
            const completed = parseInt(chartDataEl.dataset.completed) || 0;
            const inProgress = parseInt(chartDataEl.dataset.inProgress) || 0;
            const unassigned = parseInt(chartDataEl.dataset.unassigned) || 0;

            // 初始化产品状态图表
            try {
                new Chart(document.getElementById('productStatusChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['已完成', '进行中', '未分配'],
                        datasets: [{
                            data: [completed, inProgress, unassigned],
                            backgroundColor: ['#10b981', '#f59e0b', '#94a3b8'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: {
                                display: true,
                                text: `产品总数: ${completed + inProgress + unassigned}`,
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (e) {
            }

            // 解析工程师任务数据
            let engineerNames = [];
            let taskCounts = [];
            try {
                engineerNames = JSON.parse(chartDataEl.dataset.engineerNames);
                taskCounts = JSON.parse(chartDataEl.dataset.taskCounts);
            } catch (e) {
            }

            // 初始化工程师任务图表
            try {
                new Chart(document.getElementById('engineerTaskChart'), {
                    type: 'bar',
                    data: {
                        labels: engineerNames.length > 0 ? engineerNames : ['暂无数据'],
                        datasets: [{
                            label: '未完成任务数',
                            data: taskCounts.length > 0 ? taskCounts : [0],
                            backgroundColor: '#3b82f6',
                            borderWidth: 0,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    stepSize: 1
                                },
                                grid: {
                                    drawBorder: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function (tooltipItems) {
                                        return tooltipItems[0].label;
                                    }
                                }
                            }
                        },
                        indexAxis: 'y' // 水平条形图
                    }
                });
            } catch (e) {
            }
        }

        // 页面加载完成后初始化图表
        document.addEventListener('DOMContentLoaded', initCharts);
    </script>
    <style>
        .chart-container {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .search-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
    </style>
    {% endblock %}
</body>

</html>