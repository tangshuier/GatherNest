{% extends 'base.html' %}

{% block title %}é¡¹ç›®åˆ—è¡¨ - å¡ç‰‡è§†å›¾{% endblock %}

{% block page_title %}é¡¹ç›®åˆ—è¡¨{% endblock %}

{% block content %}
<style>
    /* é‡ç½®å’ŒåŸºç¡€æ ·å¼ */
    .project-grid {
        margin: 0 !important;
        padding: 0 !important;
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        box-sizing: border-box;
    }
    
    .project-grid > div {
        padding-left: 8px !important;
        padding-right: 8px !important;
        margin-bottom: 12px !important;
        box-sizing: border-box;
        min-width: 0; /* ç¡®ä¿å†…å®¹ä¸ä¼šæº¢å‡ºå®¹å™¨ */
    }
    
    /* æ ‡ç­¾æ ·å¼ - å¢å¤§å°ºå¯¸ç¡®ä¿å†…å®¹å¯è§ */
    .tag {
        display: inline-block;
        padding: 4px 6px;
        margin: 0 4px 4px 0;
        border-radius: 4px;
        font-size: 11px;
        background-color: #667eea;
        color: white;
        line-height: 1.4;
        max-width: calc(100% - 8px);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* é¡¹ç›®å¡ç‰‡æ ·å¼ - ä½¿ç”¨æ›´çµæ´»çš„å®½åº¦è®¡ç®— */
    .product-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.2s ease;
        position: relative;
        width: 100%;
        min-width: 0; /* ç¡®ä¿å†…å®¹ä¸ä¼šæº¢å‡ºå®¹å™¨ */
        min-height: 240px;
        height: auto;
        background: white;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
        margin: 0 !important;
        box-sizing: border-box;
    }
    
    .product-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
        transform: translateY(-2px) !important;
        border-color: #667eea;
    }
    
    /* å¡ç‰‡å¤´éƒ¨ - å•†å“æ ‡é¢˜åŒºåŸŸ */
    .product-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 12px;
        flex-shrink: 0;
    }
    
    .product-title {
        font-size: 14px !important;
        font-weight: 600 !important;
        margin: 0 !important;
        padding: 0 !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
    }
    
    /* å¡ç‰‡ä¸»ä½“ - é¡¹ç›®ä¿¡æ¯ */
    .product-card-body {
        flex: 1;
        padding: 10px 12px;
        font-size: 12px !important;
        overflow: hidden;
    }
    
    /* é¡¹ç›®IDå’Œç±»å‹ */
    .project-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        width: 100%;
        text-align: center;
    }
    
    .project-id {
        font-size: 12px;
        color: #999;
    }
    
    .project-type-badge {
        font-size: 10px !important;
        padding: 3px 8px !important;
        border-radius: 4px !important;
        font-weight: 600 !important;
        background: #f0f4ff;
        color: #667eea;
    }
    
    /* é¡¹ç›®ä¿¡æ¯è¡Œ - è‡ªé€‚åº”å†…å®¹å®½åº¦ */
    .product-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        line-height: 1.5;
        width: 100%;
        flex-wrap: nowrap;
        min-width: 0;
    }
    
    .product-info-label {
        font-weight: 500;
        color: #666;
        font-size: 12px !important;
        min-width: 50px;
        flex: 0 0 auto; /* è‡ªé€‚åº”å†…å®¹å®½åº¦ */
        margin-right: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .product-info-value {
        flex: 1; /* å‰©ä½™ç©ºé—´è‡ªé€‚åº” */
        text-align: center;
        font-size: 12px !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.5;
        min-width: 0;
    }
    
    .price-value {
        color: #ff4400 !important;
        font-weight: 700;
        font-size: 14px !important;
    }
    
    /* æ ‡ç­¾å®¹å™¨ - ä¼˜åŒ–å¸ƒå±€ */
    .tag-container {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        gap: 4px;
        box-sizing: border-box;
        justify-content: center;
    }
    
    /* æ—¥æœŸä¿¡æ¯ */
    .product-date {
        text-align: right;
        font-size: 11px !important;
        color: #999;
        margin-top: 6px;
    }
    
    /* å¡ç‰‡åº•éƒ¨ - æ“ä½œåŒº */
    .product-card-footer {
        background-color: #fafafa;
        padding: 8px 10px;
        border-top: 1px solid #f0f0f0;
        text-align: center;
        flex-shrink: 0;
    }
    
    /* è¯¦æƒ…æŒ‰é’® - ç²¾ç®€æ ·å¼ */
    .product-action-btn {
        font-size: 11px !important;
        padding: 6px 12px !important;
        margin: 0 !important;
        line-height: 1.5;
        min-width: 60px;
        width: 80%;
        max-width: 100px;
    }
    
    /* å¤é€‰æ¡†æ ·å¼ */
    .project-checkbox {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 12px !important;
        height: 12px !important;
        z-index: 10;
        margin: 0 !important;
    }
    
    /* å“åº”å¼ç½‘æ ¼å¸ƒå±€ - åŸºäºå†…å®¹å®½åº¦è‡ªé€‚åº” */
    @media (min-width: 0px) {
        .project-item {
            flex: 0 0 100%; /* å°å±å•åˆ—æ˜¾ç¤º */
            max-width: 100%;
        }
    }
    
    @media (min-width: 360px) {
        .project-item {
            flex: 0 0 50%; /* å°å±åŒåˆ— */
            max-width: 50%;
        }
    }
    
    @media (min-width: 640px) {
        .project-item {
            flex: 0 0 33.333333%; /* ä¸­å±ä¸‰åˆ— */
            max-width: 33.333333%;
        }
    }
    
    @media (min-width: 960px) {
        .project-item {
            flex: 0 0 25%; /* å¤§å±å››åˆ— */
            max-width: 25%;
        }
    }
    
    @media (min-width: 1200px) {
        .project-item {
            flex: 0 0 20%; /* è¶…å¤§å±äº”åˆ— */
            max-width: 20%;
        }
    }
    
    /* ç¡®ä¿é¡¹ç›®ç½‘æ ¼å®¹å™¨æ˜¯flexå¸ƒå±€ */
    .project-grid {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        box-sizing: border-box;
        padding: 0;
        margin: 0;
    }
    
    /* å¼ºåˆ¶é¡¹ç›®é¡¹ä¸ºflexé¡¹ - ä½¿ç”¨æ›´çµæ´»çš„å¸ƒå±€ */
    .project-item {
        display: flex;
        padding-left: 8px !important;
        padding-right: 8px !important;
        margin-bottom: 12px !important;
        box-sizing: border-box;
        min-width: 0; /* ç¡®ä¿å†…å®¹ä¸ä¼šæº¢å‡ºå®¹å™¨ */
        flex-basis: auto; /* å…è®¸åŸºäºå†…å®¹è‡ªåŠ¨è®¡ç®—å®½åº¦ */
    }
    
    /* æ¸…é™¤å¯èƒ½å­˜åœ¨çš„é»˜è®¤è¾¹è· */
    .card-body {
        padding: 1rem !important;
    }
</style>

<div class="section fade-in">
    <div class="card mb-4">
          <div class="card-header">
              <div class="header-title">
                  <h1 class="h2 mb-0">é¡¹ç›®åˆ—è¡¨</h1>
              </div>
          </div>
          <div class="card-body">
            <!-- æ¶ˆæ¯æç¤º -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <!-- ç­›é€‰å’Œæœç´¢è¡¨å• -->
            <div class="card mb-4">
                <div class="card-body filter-form">
                    <form class="filter-form" method="get" action="{{ url_for('project_management.projects_list') }}">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" placeholder="é¡¹ç›®åç§°/æè¿°æœç´¢" name="search" value="{{ search_query }}">
                            </div>
                            {% if current_user.role == 'super_admin' %}
                            <div class="col-md-3">
                                <select class="form-select" name="engineer_id">
                                    <option value="">é€‰æ‹©å·¥ç¨‹å¸ˆ</option>
                                    {% for engineer in engineers %}
                                    <option value="{{ engineer.id }}" {% if engineer_id == engineer.id|string %}selected{% endif %}>{{ engineer.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            <div class="col-md-3">
                                <input type="text" class="form-control" placeholder="æ ‡ç­¾æœç´¢" name="tag" value="{{ tag_search }}">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary w-100">æœç´¢</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- é¡¹ç›®åˆ—è¡¨æ“ä½œæ  -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">é¡¹ç›®ä¿¡æ¯</h5>
                    <div class="d-flex align-items-center">
                        <!-- å¡ç‰‡è§†å›¾æ˜¾ç¤º -->
                        <span class="ml-2">
                            <i class="fas fa-th-large text-secondary"></i>
                        </span>
                        
                        {% if current_user.role == 'super_admin' %}
                        <a href="{{ url_for('project_management.add_project') }}" class="btn btn-success ml-2">
                            <i class="fas fa-plus"></i> æ·»åŠ é¡¹ç›®
                        </a>
                        <button class="btn btn-danger ml-2" type="button" data-toggle="modal" data-target="#batchDeleteModal" id="batchDeleteBtn" disabled>
                            <i class="fas fa-trash-alt"></i> æ‰¹é‡åˆ é™¤
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- é¡¹ç›®åˆ—è¡¨å¡ç‰‡ -->
                <div class="card-body p-2">
                    <!-- æ·˜å®äº¬ä¸œå¼å•†å“ç½‘æ ¼å¸ƒå±€ -->
                    <div class="project-grid">
                        {% if projects %}
                            {% for project in projects %}
                                <!-- å•†å“å¼é¡¹ç›®å¡ç‰‡ -->
                                <div class="project-item">
                                    <div class="product-card">
                                        {% if current_user.role == 'super_admin' %}
                                        <input type="checkbox" class="project-checkbox" value="{{ project.id }}">
                                        {% endif %}
                                        
                                        <div class="product-card-header">
                                            <h5 class="product-title">{{ project.name|truncate(12) }}</h5>
                                        </div>
                                        
                                        <div class="product-card-body">
                                            <div class="project-meta">
                                                <span class="project-id">#{{ project.id }}</span>
                                                <span class="project-type-badge">
                                                    {{ 'å®šåˆ¶' if project.project_type == 'custom' else 'æˆå“' }}
                                                </span>
                                            </div>
                                            
                                            <div class="product-info">
                                                <span class="product-info-label">ä»·æ ¼:</span>
                                                <span class="product-info-value price-value">
                                                    {{ 'ï¿¥{:.0f}'.format(project.price) if project.price else '-' }}
                                                </span>
                                            </div>
                                            
                                            <div class="product-info">
                                                <span class="product-info-label">è´Ÿè´£äºº:</span>
                                                <span class="product-info-value">
                                                    {{ project.assigned_engineer.name if project.assigned_engineer else 'æœªåˆ†é…' }}
                                                </span>
                                            </div>
                                            
                                            {% if project.tags %}
                                            <div class="tag-container">
                                                {% for tag in project.tags[:1] %}
                                                    <span class="tag">{{ tag.name|truncate(3) }}</span>
                                                {% endfor %}
                                                {% if project.tags|length > 1 %}
                                                    <span class="tag">+{{ project.tags|length - 1 }}</span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            
                                            <div class="product-date">
                                                {{ project.created_time.strftime('%m-%d') if project.created_time else '' }}
                                            </div>
                                        </div>
                                        
                                        <div class="product-card-footer">
                                            <button class="btn btn-primary btn-sm product-action-btn view-project-details" type="button" data-project-id="{{ project.id }}">
                                                è¯¦æƒ…
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            {% else %}
                            <div class="col-12">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-folder-open"></i>
                                    </div>
                                    <h3 class="empty-state-title">æš‚æ— é¡¹ç›®æ•°æ®</h3>
                                    <p class="empty-state-description">æ•°æ®åº“ä¸­è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•é¡¹ç›®</p>
                                    {% if current_user.role == 'super_admin' or (current_user.role == 'engineer' and engineer) %}
                                    <a href="{{ url_for('project_management.add_project') }}" class="btn btn-primary">
                                        <i class="fas fa-plus mr-2"></i> æ·»åŠ ç¬¬ä¸€ä¸ªé¡¹ç›®
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- åˆ†é¡µ -->
                {% if total > per_page %}
                <div class="card-footer">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-center">
                            {% if current_page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('project_management.projects_list', page=current_page-1, view='card', search=search_query, engineer_id=engineer_id, tag=tag_search) }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in range(1, total_pages + 1) %}
                            <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('project_management.projects_list', page=page_num, view='card', search=search_query, engineer_id=engineer_id, tag=tag_search) }}">{{ page_num }}</a>
                            </li>
                            {% endfor %}
                            
                            {% if current_page < total_pages %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('project_management.projects_list', page=current_page+1, view='card', search=search_query, engineer_id=engineer_id, tag=tag_search) }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    function updateBatchDeleteButton() {
        const checkedCount = $('.project-checkbox:checked').length;
        $('#batchDeleteBtn').prop('disabled', checkedCount === 0);
    }
    
    // å•ä¸ªå¤é€‰æ¡†å˜åŒ–æ—¶æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    $(document).on('change', '.project-checkbox', function() {
        updateBatchDeleteButton();
    });
    
    // ç»‘å®šä¸Šä¼ èµ„æ–™æŒ‰é’®äº‹ä»¶
    $(document).on('click', '.upload-materials-btn', function() {
        const projectId = $(this).data('project-id');
        const projectName = $(this).data('project-name');
        openGlobalUploadModal(projectId, projectName);
    });
    
    // ç»‘å®šæŸ¥çœ‹èµ„æ–™æŒ‰é’®äº‹ä»¶
    $(document).on('click', '.view-materials-btn', function() {
        const projectId = $(this).data('project-id');
        const projectName = $(this).data('project-name');
        openGlobalMaterialsModal(projectId, projectName);
    });
    
    // ç»‘å®šåˆ é™¤é¡¹ç›®æŒ‰é’®äº‹ä»¶
    $(document).on('click', '.delete-project-btn', function() {
        const projectId = $(this).data('project-id');
        const projectName = $(this).data('project-name');
        confirmDelete(projectId, projectName);
    });
    
    // ä½¿ç”¨jQueryçš„äº‹ä»¶å§”æ‰˜å¤„ç†é¡¹ç›®è¯¦æƒ…æŒ‰é’®ç‚¹å‡»
    $(document).on('click', '.view-project-details', function() {
        var projectId = parseInt($(this).data('project-id'));
        if (typeof window.showProjectDetails === 'function') {
            try {
                window.showProjectDetails(projectId);
            } catch (error) {
                console.error('æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…æ—¶å‡ºé”™:', error);
                alert('æ— æ³•æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…ï¼Œè¯·ç¨åå†è¯•ã€‚');
            }
        } else {
            console.warn('é¡¹ç›®è¯¦æƒ…å‡½æ•°ä¸å¯ç”¨');
            alert('é¡¹ç›®è¯¦æƒ…åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚');
        }
    });
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    $(document).ready(function() {
        updateBatchDeleteButton();
    });
    </script>
    
    <!-- é¡¹ç›®è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div>
        <div id="projectDetailsModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="projectDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                        <h5 class="modal-title" id="projectDetailsModalLabel">é¡¹ç›®è¯¦æƒ…</h5>
                        <button type="button" class="close text-white" onclick="closeProjectDetails()" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="container">
                            <!-- é¡¹ç›®åç§°å’ŒIDåŒºåŸŸ -->
                            <div class="mb-4 text-center">
                                <h3 class="mb-2" id="projectDetailName">é¡¹ç›®åç§°</h3>
                                <p class="text-muted" id="projectDetailId">ID: </p>
                            </div>
                            
                            <!-- é¡¹ç›®ä¿¡æ¯è¡¨æ ¼ -->
                            <table class="table table-bordered table-hover">
                                <tbody>
                                    <tr>
                                        <td class="font-weight-bold">é¡¹ç›®ç±»å‹</td>
                                        <td id="projectDetailType">æœªè®¾ç½®</td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold">é¡¹ç›®ä»·æ ¼</td>
                                        <td id="projectDetailPrice">æœªè®¾ç½®</td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold">é¡¹ç›®æˆæœ¬</td>
                                        <td id="projectDetailCost">æœªè®¾ç½®</td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold">é¡¹ç›®å•ä»·</td>
                                        <td id="projectDetailUnitPrice">æœªè®¾ç½®</td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold">é¡¹ç›®è´Ÿè´£äºº</td>
                                        <td id="projectDetailEngineer">æœªåˆ†é…</td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold">æ‰€å±ç¾¤ç»„</td>
                                        <td id="projectDetailGroup">æœªè®¾ç½®</td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold">é¡¹ç›®æ ‡ç­¾</td>
                                        <td id="projectDetailTags"><div class="d-flex flex-wrap gap-2"></div></td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold">åˆ›å»ºæ—¶é—´</td>
                                        <td id="projectDetailTime"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- è®ºæ–‡èµ„æ–™å’Œé¡¹ç›®èµ„æ–™å±•ç¤ºåŒºåŸŸ -->
                        <div class="card mt-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">é¡¹ç›®èµ„æ–™</h5>
                            </div>
                            <div class="card-body">
                        <!-- è®ºæ–‡èµ„æ–™ -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="font-weight-bold mb-0">è®ºæ–‡èµ„æ–™</h6>
                                    <button id="uploadPaperBtn" class="btn btn-sm btn-info">
                                        <i class="fas fa-upload"></i> ä¸Šä¼ è®ºæ–‡
                                    </button>
                                </div>
                                <div id="projectDetailPapers" class="ml-2">
                                    <span class="text-muted">æš‚æ— è®ºæ–‡èµ„æ–™</span>
                                </div>
                            </div>
                        <!-- é¡¹ç›®èµ„æ–™ -->
                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="font-weight-bold mb-0">é¡¹ç›®èµ„æ–™</h6>
                                    <button id="uploadMaterialBtn" class="btn btn-sm btn-info">
                                        <i class="fas fa-upload"></i> ä¸Šä¼ èµ„æ–™
                                    </button>
                                </div>
                                <div id="projectDetailMaterials" class="ml-2">
                                    <span class="text-muted">æš‚æ— é¡¹ç›®èµ„æ–™</span>
                                </div>
                            </div>
                            
                            <script>
                            // å¤„ç†ä¸Šä¼ è®ºæ–‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                            $('#uploadPaperBtn').click(function() {
                                const projectId = $('#projectDetailId').text().split(': ')[1];
                                window.location.href = '/project_management/upload_materials/' + projectId + '?type=paper';
                            });
                            
                            // å¤„ç†ä¸Šä¼ é¡¹ç›®èµ„æ–™æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                            $('#uploadMaterialBtn').click(function() {
                                const projectId = $('#projectDetailId').text().split(': ')[1];
                                window.location.href = '/project_management/upload_materials/' + projectId + '?type=material';
                            });
                            </script>
                            </div>
                        </div>
                </div>
                    <div class="modal-footer">
                        <a id="editProjectLink" href="" class="btn btn-primary mr-2">ç¼–è¾‘é¡¹ç›®</a>
                        {% if current_user.role == 'super_admin' %}
                        <button id="deleteProjectBtn" type="button" class="btn btn-danger mr-2">åˆ é™¤é¡¹ç›®</button>
                        {% endif %}
                        <button type="button" class="btn btn-secondary" onclick="closeProjectDetails()">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¨¡æ€æ¡†èƒŒæ™¯é®ç½© -->
        <div id="modalBackdrop" class="modal-backdrop fade" style="display: none;"></div>
    </div>
    
    <script>
        // è®¾ç½®å½“å‰ç”¨æˆ·è§’è‰²æ ‡å¿—
        window.isSuperAdmin = {{ current_user.role == 'super_admin'|tojson|lower }};
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœæœ‰project_idåˆ™è‡ªåŠ¨æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
        $(document).ready(function() {
            // è·å–URLä¸­çš„project_idå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project_id');
            
            // å¦‚æœURLä¸­åŒ…å«project_idå‚æ•°ï¼Œåˆ™è‡ªåŠ¨æ‰“å¼€é¡¹ç›®è¯¦æƒ…
            if (projectId) {
                showProjectDetails(projectId);
            }
        });
        
        // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…å‡½æ•°
        window.showProjectDetails = function(projectId) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            $('#projectDetailName').text('åŠ è½½ä¸­...');
            $('#projectDetailId').text('ID: ' + projectId);
            
            // æ¸…ç©ºå…¶ä»–å­—æ®µ
            $('#projectDetailType').text('åŠ è½½ä¸­...');
            $('#projectDetailPrice').text('åŠ è½½ä¸­...');
            $('#projectDetailCost').text('åŠ è½½ä¸­...');
            $('#projectDetailUnitPrice').text('åŠ è½½ä¸­...');
            $('#projectDetailEngineer').text('åŠ è½½ä¸­...');
            $('#projectDetailGroup').text('åŠ è½½ä¸­...');
            $('#projectDetailTags div').empty();
            $('#projectDetailTime').text('åŠ è½½ä¸­...');
            
            // æ›´æ–°ç¼–è¾‘å’Œåˆ é™¤é“¾æ¥
            $('#editProjectLink').attr('href', '/project_management/edit_project/' + projectId);
            $('#deleteProjectBtn').data('project-id', projectId);
            
            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            $('#deleteProjectBtn').off('click').on('click', function() {
                const pid = $(this).data('project-id');
                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤é¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    window.location.href = '/project_management/delete_project/' + pid;
                }
            });
            
            // è°ƒç”¨APIè·å–é¡¹ç›®è¯¦æƒ…
            $.ajax({
                url: '/project_management/get_project_details/' + projectId,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    // å¡«å……é¡¹ç›®è¯¦æƒ…
                    $('#projectDetailName').text(data.name);
                    $('#projectDetailId').text('ID: ' + data.id);
                    $('#projectDetailType').text(data.project_type);
                    $('#projectDetailPrice').text(data.price ? 'ï¿¥' + data.price.toFixed(2) : 'æœªè®¾ç½®');
                    $('#projectDetailCost').text(data.cost ? 'ï¿¥' + data.cost.toFixed(2) : 'æœªè®¾ç½®');
                    $('#projectDetailUnitPrice').text(data.unit_price ? 'ï¿¥' + data.unit_price.toFixed(2) : 'æœªè®¾ç½®');
                    $('#projectDetailEngineer').text(data.engineer);
                    $('#projectDetailGroup').text(data.group_name);
                    $('#projectDetailTime').text(data.created_time);
                    
                    // å¡«å……æ ‡ç­¾
                    const tagsContainer = $('#projectDetailTags div');
                    tagsContainer.empty();
                    if (data.tags && data.tags.length > 0) {
                        data.tags.forEach(function(tag) {
                            tagsContainer.append('<span class="tag">' + tag.name + '</span>');
                        });
                    } else {
                        tagsContainer.append('<span class="text-muted">æ— æ ‡ç­¾</span>');
                    }
                    
                    // å¡«å……è®ºæ–‡èµ„æ–™å’Œé¡¹ç›®èµ„æ–™
                    const papersContainer = $('#projectDetailPapers');
                    const materialsContainer = $('#projectDetailMaterials');
                    
                    // æ¸…ç©ºå®¹å™¨
                    papersContainer.empty();
                    materialsContainer.empty();
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æ¡£æ•°æ®
                    if (data.documents && data.documents.length > 0) {
                        // åˆ†ç¦»è®ºæ–‡èµ„æ–™å’Œé¡¹ç›®èµ„æ–™
                        const papers = data.documents.filter(doc => doc.type === 'paper');
                        const materials = data.documents.filter(doc => doc.type !== 'paper');
                        
                        // æ˜¾ç¤ºè®ºæ–‡èµ„æ–™
                        if (papers.length > 0) {
                            const papersList = $('<ul class="list-unstyled"></ul>');
                            papers.forEach(function(paper) {
                                const downloadUrl = '/project_management/download_materials/' + paper.id;
                                papersList.append('<li><a href="' + downloadUrl + '" target="_blank">ğŸ“„ ' + paper.filename + '</a></li>');
                            });
                            papersContainer.append(papersList);
                        } else {
                            papersContainer.append('<span class="text-muted">æš‚æ— è®ºæ–‡èµ„æ–™</span>');
                        }
                        
                        // æ˜¾ç¤ºé¡¹ç›®èµ„æ–™
                        if (materials.length > 0) {
                            const materialsList = $('<ul class="list-unstyled"></ul>');
                            materials.forEach(function(material) {
                                const downloadUrl = '/project_management/download_materials/' + material.id;
                                materialsList.append('<li><a href="' + downloadUrl + '" target="_blank">ğŸ“ ' + material.filename + '</a></li>');
                            });
                            materialsContainer.append(materialsList);
                        } else {
                            materialsContainer.append('<span class="text-muted">æš‚æ— é¡¹ç›®èµ„æ–™</span>');
                        }
                    } else {
                        papersContainer.append('<span class="text-muted">æš‚æ— è®ºæ–‡èµ„æ–™</span>');
                        materialsContainer.append('<span class="text-muted">æš‚æ— é¡¹ç›®èµ„æ–™</span>');
                    }
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    $('#projectDetailsModal').modal('show');
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'è·å–é¡¹ç›®è¯¦æƒ…å¤±è´¥';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.error || errorMessage;
                    } catch (e) {
                        // è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯ä¿¡æ¯
                    }
                    
                    alert(errorMessage);
                    console.error('è·å–é¡¹ç›®è¯¦æƒ…é”™è¯¯:', error);
                }
            });
        };
        
        // å…³é—­é¡¹ç›®è¯¦æƒ…æ¨¡æ€æ¡†
        window.closeProjectDetails = function() {
            $('#projectDetailsModal').modal('hide');
        };
    </script>
{% endblock %}