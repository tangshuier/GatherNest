{% extends 'base.html' %}

{% block title %}编辑项目{% endblock %}

{% block content %}
<style>
    .section {
        margin-bottom: 2rem;
        padding: 25px;
    }
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .tag-checkbox {
        margin-right: 15px;
        margin-bottom: 10px;
        display: inline-block;
    }
    /* 调整容器宽度以与其他页面保持一致 */
    .card-body {
        max-width: 100%;
    }
    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }
</style>

<div class="section fade-in">
        <div class="card mb-4">
            <div class="card-header">
                <div class="header-title">
                    <h1 class="h2 mb-0">编辑项目</h1>
                </div>
            </div>
            <div class="card-body">
                <!-- 消息提示 -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                <!-- 编辑项目表单 -->
                <form method="post" action="{{ url_for('project_management.edit_project', project_id=project.id) }}">
                        <div class="mb-4">
                            <label for="name" class="form-label">项目名称</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ project.name }}" placeholder="请输入项目名称" required>
                        </div>
                        
                        <div class="mb-4">
                            <label for="project_type" class="form-label">项目类型</label>
                            <select class="form-select" id="project_type" name="project_type">
                                <option value="custom" {% if project.project_type == 'custom' %}selected{% endif %}>定制项目</option>
                                <option value="finished" {% if project.project_type == 'finished' %}selected{% endif %}>成品项目</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label for="price" class="form-label">项目总价</label>
                            <input type="number" step="0.01" class="form-control" id="price" name="price" value="{{ project.price }}" placeholder="请输入项目总价">
                        </div>
                        
                        <div class="mb-4">
                            <label for="cost" class="form-label">成本</label>
                            <input type="number" step="0.01" class="form-control" id="cost" name="cost" value="{{ project.cost }}" placeholder="请输入成本">
                        </div>
                        
                        <div class="mb-4">
                            <label for="unit_price" class="form-label">单价</label>
                            <input type="number" step="0.01" class="form-control" id="unit_price" name="unit_price" value="{{ project.unit_price }}" placeholder="请输入单价">
                        </div>
                        
                        <div class="mb-4">
                            <label for="group_name" class="form-label">群名（定制项目必填）</label>
                            <input type="text" class="form-control" id="group_name" name="group_name" value="{{ project.group_name }}" placeholder="请输入群名">
                        </div>
                        
                        <div class="mb-4">
                            <label for="description" class="form-label">项目描述</label>
                            <textarea class="form-control" id="description" name="description" rows="4" placeholder="请输入项目描述">{{ project.description }}</textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="status" class="form-label">项目状态</label>
                            <select class="form-select" id="status" name="status">
                                <option value="not_started" {% if project.status == 'not_started' %}selected{% endif %}>未开始</option>
                                <option value="in_progress" {% if project.status == 'in_progress' %}selected{% endif %}>进行中</option>
                                <option value="pending_review" {% if project.status == 'pending_review' %}selected{% endif %}>待审核</option>
                                <option value="completed" {% if project.status == 'completed' %}selected{% endif %}>已完成</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">选择标签</label>
                            <div>
                                {% if tags %}
                                {% for tag in tags %}
                                <div class="tag-checkbox">
                                    <input type="checkbox" id="tag-{{ tag.id }}" name="tags" value="{{ tag.id }}" {% if tag in project.tags %}checked{% endif %}>
                                    <label for="tag-{{ tag.id }}">{{ tag.name }}</label>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="text-muted">暂无可用标签</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            {% if current_user.role_level < 3 %}
                            <!-- 管理员显示添加新标签 -->
                            <a href="{{ url_for('project_management.add_tag') }}" class="btn btn-outline-info btn-sm shadow-sm" style="padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 400; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; border: 1px solid transparent; background-color: transparent; display: inline-block; text-decoration: none; font-size: 0.875rem; line-height: 1.5; border-color: #17a2b8; color: #17a2b8;">
                                <span data-feather="tag"></span> 添加新标签
                            </a>
                            {% else %}
                            <!-- 工程师显示申请新标签 -->
                            <a href="{{ url_for('project_management.request_tag') }}" class="btn btn-outline-info btn-sm shadow-sm" style="padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 400; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; border: 1px solid transparent; background-color: transparent; display: inline-block; text-decoration: none; font-size: 0.875rem; line-height: 1.5; border-color: #17a2b8; color: #17a2b8;">
                                <span data-feather="tag"></span> 申请新标签
                            </a>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('project_management.projects_list') }}" class="btn btn-secondary me-2 shadow-sm" style="padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 400; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; border: 1px solid transparent; display: inline-block; text-decoration: none; font-size: 1rem; line-height: 1.5; background-color: #6c757d; border-color: #6c757d; color: #fff;">取消</a>
                            <button type="submit" class="btn btn-primary" style="padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 400; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; border: 1px solid transparent; font-size: 1rem; line-height: 1.5; background-color: #007bff; border-color: #007bff; color: #fff;">保存修改</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 表单验证增强
        const form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            const name = document.getElementById('name');
            if (!name.value.trim()) {
                name.classList.add('is-invalid');
                event.preventDefault();
            } else {
                name.classList.remove('is-invalid');
            }
        });
    });
</script>
{% endblock %}