{% extends 'base.html' %}

{% block title %}添加项目{% endblock %}

{% block content %}
<style>
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .form-label {
        font-weight: 500;
    }
    .tag-checkbox {
        margin-right: 15px;
        margin-bottom: 10px;
        display: inline-block;
    }
    /* 自定义侧边导航 */
    .custom-sidebar {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .custom-sidebar h6 {
        color: #495057;
        margin-bottom: 15px;
        font-weight: 600;
    }
    .custom-sidebar .nav-link {
        display: flex;
        align-items: center;
        color: #6c757d;
        padding: 8px 12px;
        margin-bottom: 5px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    .custom-sidebar .nav-link:hover {
        background-color: #e9ecef;
        color: #495057;
    }
    .custom-sidebar .nav-link.active {
        background-color: #007bff;
        color: white;
    }
    .custom-sidebar .nav-link i {
        margin-right: 10px;
    }
    .form-section {
        padding: 20px;
    }
</style>

<div class="page-content">
    <div class="row">
        <!-- 侧边导航 -->
        <div class="col-md-3">
            <div class="custom-sidebar">
                <h6>功能导航</h6>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('project_management.projects_list') }}">
                            <i class="fas fa-list"></i>
                            项目列表
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('project_management.add_project') }}">
                            <i class="fas fa-plus-circle"></i>
                            添加项目
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('project_management.request_tag') }}">
                            <i class="fas fa-tag"></i>
                            申请标签
                        </a>
                    </li>
                    {% if current_user.role == 'super_admin' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('project_management.manage_tag_requests') }}">
                            <i class="fas fa-check-circle"></i>
                            管理标签申请
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>

            <!-- 主内容区 -->
            <div class="col-md-9">
                <div class="pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">添加项目</h1>
                </div>

                <!-- 消息提示 -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                <!-- 添加项目表单 -->
                <div class="card">
                    <div class="card-body form-section">
                    <form method="post" action="{{ url_for('project_management.add_project') }}">
                        {% if current_user.role == 'super_admin' and engineers %}
                        <div class="mb-4">
                            <label for="engineer_id" class="form-label">选择工程师</label>
                            <select class="form-select" id="engineer_id" name="engineer_id" required>
                                <option value="">请选择工程师</option>
                                {% for engineer in engineers %}
                                <option value="{{ engineer.id }}">{{ engineer.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        
                        <div class="mb-4">
                            <label for="name" class="form-label">项目名称</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ name }}" placeholder="请输入项目名称" required>
                        </div>
                        
                        <div class="mb-4">
                            <label for="project_type" class="form-label">项目类型</label>
                            <select class="form-select" id="project_type" name="project_type" required>
                                <option value="custom">定制项目</option>
                                <option value="finished">成品项目</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label for="price" class="form-label">项目总价</label>
                            <input type="number" step="0.01" class="form-control" id="price" name="price" placeholder="请输入项目总价">
                        </div>
                        
                        <div class="mb-4">
                            <label for="cost" class="form-label">成本</label>
                            <input type="number" step="0.01" class="form-control" id="cost" name="cost" placeholder="请输入成本">
                        </div>
                        
                        <div class="mb-4">
                            <label for="unit_price" class="form-label">单价</label>
                            <input type="number" step="0.01" class="form-control" id="unit_price" name="unit_price" placeholder="请输入单价">
                        </div>
                        
                        <div class="mb-4">
                            <label for="group_name" class="form-label">群名（定制项目必填）</label>
                            <input type="text" class="form-control" id="group_name" name="group_name" placeholder="请输入群名">
                        </div>
                        
                        <div class="mb-4">
                            <label for="description" class="form-label">项目描述</label>
                            <textarea class="form-control" id="description" name="description" rows="4" placeholder="请输入项目描述">{{ description }}</textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="status" class="form-label">项目状态</label>
                            <select class="form-select" id="status" name="status">
                                <option value="not_started">未开始</option>
                                <option value="in_progress">进行中</option>
                                <option value="pending_review">待审核</option>
                                <option value="completed">已完成</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">选择标签</label>
                            <div>
                                {% if tags %}
                                {% for tag in tags %}
                                <div class="tag-checkbox">
                                    <input type="checkbox" id="tag-{{ tag.id }}" name="tags" value="{{ tag.id }}" {% if selected_tags and tag.id|string in selected_tags %}checked{% endif %}>
                                    <label for="tag-{{ tag.id }}">{{ tag.name }}</label>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="text-muted">暂无可用标签，请先<a href="{{ url_for('project_management.request_tag') }}">申请标签</a></div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            {% if current_user.role_level < 3 %}
                            <!-- 管理员显示添加新标签 -->
                            <a href="{{ url_for('project_management.add_tag') }}" class="btn btn-outline-info btn-sm shadow-sm" style="padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 400; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; border: 1px solid transparent; background-color: transparent; display: inline-block; text-decoration: none; font-size: 0.875rem; line-height: 1.5; border-color: #17a2b8; color: #17a2b8;">
                                <span data-feather="tag"></span> 添加新标签
                            </a>
                            {% else %}
                            <!-- 工程师显示申请新标签 -->
                            <a href="{{ url_for('project_management.request_tag') }}" class="btn btn-outline-info btn-sm shadow-sm" style="padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 400; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; border: 1px solid transparent; background-color: transparent; display: inline-block; text-decoration: none; font-size: 0.875rem; line-height: 1.5; border-color: #17a2b8; color: #17a2b8;">
                                <span data-feather="tag"></span> 申请新标签
                            </a>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-end mt-5">
                            <a href="{{ url_for('project_management.projects_list') }}" class="btn btn-secondary me-3 shadow-sm" style="padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 400; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; border: 1px solid transparent; display: inline-block; text-decoration: none; font-size: 1rem; line-height: 1.5; background-color: #6c757d; border-color: #6c757d; color: #fff;">取消</a>
                            <button type="submit" class="btn btn-primary" style="padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 400; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; border: 1px solid transparent; font-size: 1rem; line-height: 1.5; background-color: #007bff; border-color: #007bff; color: #fff;">创建项目</button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 表单验证增强
            const form = document.querySelector('form');
            form.addEventListener('submit', function(event) {
                const name = document.getElementById('name');
                if (!name.value.trim()) {
                    name.classList.add('is-invalid');
                    event.preventDefault();
                } else {
                    name.classList.remove('is-invalid');
                }
            });
        });
    </script>
</div>
</div>
{% endblock %}