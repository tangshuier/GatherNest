{% extends 'base.html' %}

{% block title %}{% if edit_product %}编辑产品{% else %}添加新产品{% endif %} - 产品管理系统{% endblock %}
{% block page_title %}产品管理 - {% if edit_product %}编辑产品{% else %}添加新产品{% endif %}{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- 添加新产品表单 -->
  <div class="card mb-6">
    <div class="card-header bg-primary text-white">
      <h2 class="h5 mb-0">添加新产品</h2>
    </div>
    <div class="card-body">
          <div class="mb-4">
            <!-- 添加产品类型分页 -->
            <nav aria-label="产品类型分页">
              <ul class="pagination pagination-sm">
                <li class="page-item {% if not edit_product or edit_product.product_type == 'custom' %}active{% endif %}" id="add-custom-type">
                  <a class="page-link" href="#" data-type="custom">定制</a>
                </li>
                <li class="page-item {% if edit_product and edit_product.product_type == 'finished' %}active{% endif %}" id="add-finished-type">
                  <a class="page-link" href="#" data-type="finished">成品</a>
                </li>
              </ul>
            </nav>
          </div>
          <form id="productForm" method="post" action="{{ url_for('project.update_project') if edit_project else url_for('project.add_product_manual') }}" enctype="multipart/form-data" class="row g-3">
            {% if edit_product %}
            <input type="hidden" id="project_id" name="project_id" value="{{ edit_product.id }}">
            {% endif %}
            <input type="hidden" id="productType" name="product_type" value="{{ edit_product.product_type if edit_product else 'custom' }}">
            
            <!-- 成品表单内容 -->
            <div id="finished-product-form" style="display: {% if edit_product and edit_product.product_type == 'finished' %}block{% else %}none{% endif %}">
              <div class="form-group col-md-6">
                <label for="productName" class="form-label">产品名称 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="productName" name="name" value="{{ edit_product.name if edit_product and edit_product.product_type == 'finished' else '' }}" placeholder="格式: 001-产品名">
                <small class="form-text text-muted">产品编号(前3位数字)不能重复，产品名称可以重复</small>
              </div>
              <div class="form-group col-md-6">
                <label for="productPrice" class="form-label">产品价格</label>
                <input type="number" class="form-control" id="productPrice" name="price" step="0.01" value="{{ edit_product.price if edit_product and edit_product.product_type == 'finished' else '' }}" placeholder="选填">
              </div>
            </div>
            
            <!-- 定制产品表单内容 -->
            <div id="custom-product-form" style="display: {% if not edit_product or edit_product.product_type == 'custom' %}block{% else %}none{% endif %}">
              <div class="form-group col-md-6">
                <label for="customProductName" class="form-label">产品名称 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="customProductName" name="name" value="{{ edit_product.name if edit_product and edit_product.product_type == 'custom' else '' }}" placeholder="请输入项目名称">
                <small class="form-text text-muted">产品名称可以根据实际需求自由填写</small>
              </div>
              <div class="form-group col-md-6">
                <label for="groupName" class="form-label">群名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="groupName" name="group_name" value="{{ edit_product.group_name if edit_product else '' }}" placeholder="群名" required>
              </div>
              <div class="form-group col-md-4">
                <label for="customProductPrice" class="form-label">产品总价 <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="customProductPrice" name="price" step="0.01" value="{{ edit_product.price if edit_product and edit_product.product_type == 'custom' else '' }}" placeholder="必填" required>
              </div>
              <div class="form-group col-md-4">
                <label for="productCost" class="form-label">成本 <small class="text-muted">(选填)</small></label>
              </div>
              <div class="form-group col-md-4">
                <label for="productProgress" class="form-label">进度 <span class="text-danger">*</span></label>
                <select class="form-control" id="productProgress" name="progress" required>
                  <option value="无方案" {% if edit_product and edit_product.progress == '无方案' %}selected{% endif %}>无方案</option>
                  <option value="方案未确认" {% if edit_product and edit_product.progress == '方案未确认' %}selected{% endif %}>方案未确认</option>
                  <option value="需要方案" {% if edit_product and edit_product.progress == '需要方案' %}selected{% endif %}>需要方案</option>
                  <option value="确认方案不制作" {% if edit_product and edit_product.progress == '确认方案不制作' %}selected{% endif %}>确认方案不制作</option>
                  <option value="待制作" {% if edit_product and edit_product.progress == '待制作' %}selected{% endif %}>待制作</option>
                  {% if current_user.role in ['admin', 'engineer'] %}
                  <option value="制作中" {% if edit_product and edit_product.progress == '制作中' %}selected{% endif %}>制作中</option>
                  <option value="完成待确认" {% if edit_product and edit_product.progress == '完成待确认' %}selected{% endif %}>完成待确认</option>
                  <option value="确认不发货" {% if edit_product and edit_product.progress == '确认不发货' %}selected{% endif %}>确认不发货</option>
                  <option value="确认待发货" {% if edit_product and edit_product.progress == '确认待发货' %}selected{% endif %}>确认待发货</option>
                  <option value="已完成" {% if edit_product and edit_product.progress == '已完成' %}selected{% endif %}>已完成</option>
                  <option value="售后修改" {% if edit_product and edit_product.progress == '售后修改' %}selected{% endif %}>售后修改</option>
                  <option value="结单" {% if edit_product and edit_product.progress == '结单' %}selected{% endif %}>结单</option>
                  {% endif %}
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="unitPrice" class="form-label">单价 <small class="text-muted">(选填)</small></label>
                <input type="number" class="form-control" id="productCost" name="cost" step="0.01" value="{{ edit_product.cost if edit_product else '' }}" placeholder="选填">
              </div>
              <div class="form-group col-md-4">
                <label for="unitPrice" class="form-label">单价 <small class="text-muted">(选填)</small></label>
                <input type="number" class="form-control" id="unitPrice" name="unit_price" step="0.01" value="{{ edit_product.unit_price if edit_product else '' }}" placeholder="选填">
              </div>
            </div>
            
            <!-- 通用字段 -->
              <div class="form-group col-md-6">
                  <label for="engineerSelect" class="form-label">分配工程师 <small class="text-muted">(选填)</small></label>
                  <!-- 自定义工程师选择框 -->
                  <div class="custom-dropdown" style="position: relative; width: 100%;">
                      <button type="button" class="custom-dropdown-btn" style="
                          width: 100%;
                          padding: 0.375rem 0.75rem;
                          background-color: #fff;
                          border: 1px solid #ced4da;
                          border-radius: 4px;
                          text-align: left;
                          cursor: pointer;
                          font-size: 1rem;
                          line-height: 1.5;
                          display: flex;
                          justify-content: space-between;
                          align-items: center;
                      " onclick="toggleDropdown('engineerOptions')">
                          <span id="selectedEngineer" style="color: #333;">{{ edit_product.assigned_engineer.name if edit_product and edit_product.assigned_engineer else '请选择' }}</span>
                          <span style="color: #666;">▼</span>
                      </button>
                      <!-- 下拉选项容器 -->
                      <div id="engineerOptions" class="custom-dropdown-options" style="
                          position: absolute;
                          top: 100%;
                          left: 0;
                          right: 0;
                          max-height: 200px;
                          overflow-y: auto;
                          background-color: #fff;
                          border: 1px solid #ced4da;
                          border-top: none;
                          border-radius: 0 0 4px 4px;
                          display: none;
                          z-index: 1000;
                      ">
                          <input type="hidden" name="engineer_id" id="engineerId" value="{{ edit_product.assigned_engineer_id if edit_product else '' }}">
                      <div style="padding: 8px; cursor: pointer;" onclick="selectEngineer('', '请选择')">请选择</div>
                      {% for engineer in engineers %}
                      <div style="padding: 8px; cursor: pointer;" onclick="selectEngineer('{{ engineer.id }}', '{{ engineer.name if engineer.name else (engineer.user.username if engineer.user else '未知用户') }}')">
                          {{ engineer.name if engineer.name else (engineer.user.username if engineer.user else '未知用户') }}
                      </div>
                      {% endfor %}
                      </div>
                  </div>
              </div>
              
              <div class="form-group col-md-6">
                  <label for="productDocument" class="form-label">上传文档 <small class="text-muted">(选填)</small></label>
                  <input type="file" class="form-control" id="productDocument" name="document">
                  <small class="form-text text-muted">支持 PDF, DOC, DOCX 格式文件</small>
              </div>
              
              <div class="form-group col-12">
                  <label for="productImages" class="form-label">上传产品图片 <small class="text-muted">(选填)</small></label>
                  <input type="file" class="form-control" id="productImages" name="images" multiple>
                  <small class="form-text text-muted">支持 JPG, JPEG, PNG, GIF 格式文件，可上传多个图片</small>
              </div>
              
              <div class="form-group col-12">
                  <label for="productDescription" class="form-label">产品描述 <small class="text-muted">(选填)</small></label>
                  <textarea class="form-control" id="productDescription" name="description" rows="3" placeholder="请输入产品描述">{{ edit_product.requirements if edit_product else '' }}</textarea>
              </div>
              
              <div class="form-group col-12 d-flex justify-content-end">
                  <a href="/products/management" class="btn btn-secondary mr-2">取消</a>
                  <button type="submit" class="btn btn-primary">{% if edit_product %}更新产品{% else %}添加产品{% endif %}</button>
              </div>
          </form>
    </div>
  </div>
</div>

<script>
  // 切换产品类型表单
  document.addEventListener('DOMContentLoaded', function() {
    const customTypeBtn = document.getElementById('add-custom-type');
    const finishedTypeBtn = document.getElementById('add-finished-type');
    const customForm = document.getElementById('custom-product-form');
    const finishedForm = document.getElementById('finished-product-form');
    const productTypeInput = document.getElementById('productType');
    const form = document.getElementById('productForm');
    
    customTypeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      customTypeBtn.classList.add('active');
      finishedTypeBtn.classList.remove('active');
      customForm.style.display = 'block';
      finishedForm.style.display = 'none';
      productTypeInput.value = 'custom';
      
      // 对于编辑模式，同步表单值
      {% if edit_product %}
      document.getElementById('customProductName').value = '{{ edit_product.name }}';
      document.getElementById('customProductPrice').value = '{{ edit_product.price }}';
      {% endif %}
    });
    
    finishedTypeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      finishedTypeBtn.classList.add('active');
      customTypeBtn.classList.remove('active');
      finishedForm.style.display = 'block';
      customForm.style.display = 'none';
      productTypeInput.value = 'finished';
      
      // 对于编辑模式，同步表单值
      {% if edit_product %}
      document.getElementById('productName').value = '{{ edit_product.name }}';
      document.getElementById('productPrice').value = '{{ edit_product.price }}';
      {% endif %}
    });
    
    // 如果是编辑模式，根据产品类型初始化表单
    {% if edit_product %}
    // 确保表单正确显示
    if ('{{ edit_product.product_type }}' === 'custom') {
      customForm.style.display = 'block';
      finishedForm.style.display = 'none';
      customTypeBtn.classList.add('active');
      finishedTypeBtn.classList.remove('active');
      // 确保定制产品表单的值正确设置
      document.getElementById('customProductName').value = '{{ edit_product.name }}';
      document.getElementById('customProductPrice').value = '{{ edit_product.price }}';
    } else {
      customForm.style.display = 'none';
      finishedForm.style.display = 'block';
      customTypeBtn.classList.remove('active');
      finishedTypeBtn.classList.add('active');
      // 确保成品产品表单的值正确设置
      document.getElementById('productName').value = '{{ edit_product.name }}';
      document.getElementById('productPrice').value = '{{ edit_product.price }}';
      // 对于成品产品，移除群名的必填验证
      document.getElementById('groupName').removeAttribute('required');
    }
    {% endif %}
    
    // 为了确保所有浏览器兼容性，直接修改表单字段的name属性而不是创建隐藏字段
    
    // 初始化时禁用非活动表单的name和price字段
    function updateFormFields() {
      const isCustomActive = customTypeBtn.classList.contains('active');
      
      // 根据当前激活的表单类型设置字段的name属性
      if (isCustomActive) {
        // 定制产品激活时
        document.getElementById('customProductName').setAttribute('name', 'name');
        document.getElementById('customProductPrice').setAttribute('name', 'price');
        document.getElementById('productName').removeAttribute('name');
        document.getElementById('productPrice').removeAttribute('name');
      } else {
        // 成品产品激活时
        document.getElementById('productName').setAttribute('name', 'name');
        document.getElementById('productPrice').setAttribute('name', 'price');
        document.getElementById('customProductName').removeAttribute('name');
        document.getElementById('customProductPrice').removeAttribute('name');
      }
    }
    
    // 在产品类型切换时更新字段
    customTypeBtn.addEventListener('click', updateFormFields);
    finishedTypeBtn.addEventListener('click', updateFormFields);
    
    // 初始页面加载时设置正确的字段
    updateFormFields();
    
    // 添加简单的表单提交前验证，确保name字段不为空
    form.addEventListener('submit', function(e) {
      const isCustomActive = customTypeBtn.classList.contains('active');
      let nameField, nameValue;
      
      if (isCustomActive) {
        nameField = document.getElementById('customProductName');
        nameValue = nameField.value.trim();
      } else {
        nameField = document.getElementById('productName');
        nameValue = nameField.value.trim();
      }
      
      // 简单的前端验证提示
      if (!nameValue) {
        alert('产品名称不能为空');
        nameField.focus();
        e.preventDefault(); // 阻止表单提交
        return;
      }
      
      // 再次确认字段设置正确
      updateFormFields();
    });
  });
  
  // 自定义下拉菜单功能
  function toggleDropdown(id) {
    const dropdown = document.getElementById(id);
    if (dropdown.style.display === 'block') {
      dropdown.style.display = 'none';
    } else {
      dropdown.style.display = 'block';
    }
  }
  
  function selectEngineer(id, name) {
    document.getElementById('selectedEngineer').textContent = name;
    document.getElementById('engineerId').value = id;
    document.getElementById('engineerOptions').style.display = 'none';
  }
  
  // 点击其他地方关闭下拉菜单
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.custom-dropdown')) {
      document.getElementById('engineerOptions').style.display = 'none';
    }
  });
</script>
{% endblock %}