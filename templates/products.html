{% extends 'base.html' %}

{% block title %}产品管理 - 产品管理系统{% endblock %}
{% block page_title %}产品管理{% endblock %}

{% block content %}
<!-- 添加新产品表单 -->
<div class="card fade-in mb-6">
  <div class="card-header bg-primary text-white">
    <h2 class="h5 mb-0"><i class="fas fa-plus-circle mr-2"></i>添加新产品</h2>
  </div>
  <div class="card-body">
        <div class="mb-4">
          <!-- 添加产品类型分页 -->
          <nav aria-label="产品类型分页">
            <ul class="pagination pagination-sm">
              <li class="page-item active" id="add-custom-type">
                <a class="page-link" href="#" data-type="custom">定制</a>
              </li>
              <li class="page-item" id="add-finished-type">
                <a class="page-link" href="#" data-type="finished">成品</a>
              </li>
            </ul>
          </nav>
        </div>
        <form method="post" action="/add_product_manual" enctype="multipart/form-data" class="row g-3"
          style="position: relative;"
          onsubmit="return validateProductForm()">
          <input type="hidden" id="form_errors" value="" >
            <input type="hidden" id="productType" name="product_type" value="custom">
            
            <!-- 成品表单内容 -->
            <div id="finished-product-form" style="display: none;">
              <div class="form-group col-md-6 form-animation">
                <label for="productName" class="form-label">
                  <i class="fas fa-box mr-2"></i>产品名称 <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <input type="text" class="form-control" id="productName" name="name" placeholder="格式: 001-产品名"
                    required oninput="validateField(this)">
                  <div class="field-icon"></div>
                </div>
                <small class="form-text text-muted">产品编号(前3位数字)不能重复，产品名称可以重复</small>
              </div>
              <div class="form-group col-md-6 form-animation">
                <label for="productPrice" class="form-label">
                  <i class="fas fa-yuan-sign mr-2"></i>产品价格
                </label>
                <div class="position-relative">
                  <input type="number" class="form-control" id="productPrice" name="price" step="0.01" placeholder="选填"
                    oninput="validateField(this)">
                  <div class="field-icon"></div>
                </div>
              </div>
            </div>
            
            <!-- 定制产品表单内容 -->
            <div id="custom-product-form">
              <div class="form-group col-md-6 form-animation">
                <label for="customProductName" class="form-label">
                  <i class="fas fa-tasks mr-2"></i>产品名称 <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <input type="text" class="form-control" id="customProductName" name="name" placeholder="请输入项目名称"
                    required oninput="validateField(this)">
                  <div class="field-icon"></div>
                </div>
                <small class="form-text text-muted">产品名称可以根据实际需求自由填写</small>
              </div>
              <div class="form-group col-md-6 form-animation">
                <label for="groupName" class="form-label">
                  <i class="fas fa-users mr-2"></i>群名 <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <input type="text" class="form-control" id="groupName" name="group_name" placeholder="群名" required
                    oninput="validateField(this)">
                  <div class="field-icon"></div>
                </div>
              </div>
              <div class="form-group col-md-4 form-animation">
                <label for="customProductPrice" class="form-label">
                  <i class="fas fa-yen-sign mr-2"></i>产品总价 <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                  <input type="number" class="form-control" id="customProductPrice" name="price" step="0.01" placeholder="必填" required
                    oninput="validateField(this)">
                  <div class="field-icon"></div>
                </div>
              </div>
              <div class="form-group col-md-4 form-animation">
                <label for="productCost" class="form-label">
                  <i class="fas fa-tag mr-2"></i>成本 <small class="text-muted">(选填)</small>
                </label>
                <div class="position-relative">
                  <input type="number" class="form-control" id="productCost" name="cost" step="0.01" placeholder="选填"
                    oninput="validateField(this)">
                  <div class="field-icon"></div>
                </div>
              </div>
              <div class="form-group col-md-4 form-animation">
                <label for="unitPrice" class="form-label">
                  <i class="fas fa-percentage mr-2"></i>单价 <small class="text-muted">(选填)</small>
                </label>
                <div class="position-relative">
                  <input type="number" class="form-control" id="unitPrice" name="unit_price" step="0.01" placeholder="选填"
                    oninput="validateField(this)">
                  <div class="field-icon"></div>
                </div>
              </div>
            </div>
            
            <!-- 通用字段 -->
              <div class="form-group col-md-6 form-animation">
                  <label for="engineerSelect" class="form-label">
                    <i class="fas fa-user-tie mr-2"></i>分配工程师 <small class="text-muted">(选填)</small>
                  </label>
                  <!-- 自定义工程师选择框 -->
                  <div class="custom-dropdown dropdown-hover" style="position: relative; width: 100%;">
                      <button type="button" class="custom-dropdown-btn" style="
                          width: 100%;
                          padding: 0.375rem 0.75rem;
                          background-color: #fff;
                          border: 1px solid #ced4da;
                          border-radius: 4px;
                          text-align: left;
                          cursor: pointer;
                          font-size: 1rem;
                          line-height: 1.5;
                          display: flex;
                          justify-content: space-between;
                          align-items: center;
                          transition: all 0.3s ease;
                      " onclick="toggleDropdown('engineerOptions')"
                      onmouseenter="this.style.borderColor = '#4a90e2'; this.style.boxShadow = '0 0 0 2px rgba(74, 144, 226, 0.2)'"
                      onmouseleave="if (!this.classList.contains('active')) { this.style.borderColor = '#ced4da'; this.style.boxShadow = 'none'; }"
                      >
                          <span id="selectedEngineer" style="color: #333;">请选择</span>
                          <i class="fas fa-chevron-down transition-transform duration-300" style="color: #666;"></i>
                      </button>
                      <!-- 下拉选项容器 -->
                      <div id="engineerOptions" class="custom-dropdown-options" style="
                          position: absolute;
                          top: 100%;
                          left: 0;
                          right: 0;
                          max-height: 200px;
                          overflow-y: auto;
                          background-color: #fff;
                          border: 1px solid #ced4da;
                          border-top: none;
                          border-radius: 0 0 4px 4px;
                          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                          z-index: 1000;
                          opacity: 0;
                          transform: translateY(-10px);
                          transition: all 0.3s ease;
                          visibility: hidden;
                          border-radius: 0 0 4px 4px;
                          z-index: 1000;
                          display: none;
                      ">
                          <div 
                              class="dropdown-option" 
                              data-value="" 
                              onclick="selectEngineer(this, 'engineer_id', 'engineerOptions')"
                              style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f8f9fa;"
                          >
                              请选择
                          </div>
                          {% for engineer in engineers %}
                          <div 
                              class="dropdown-option" 
                              data-value="{{ engineer.id }}" 
                              onclick="selectEngineer(this, 'engineer_id', 'engineerOptions')"
                              style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f8f9fa;"
                          >
                              {{ engineer.name }}
                          </div>
                          {% endfor %}
                      </div>
                      <!-- 隐藏的input用于表单提交 -->
                      <input type="hidden" id="engineer_id" name="engineer_id" value="">
                  </div>
                  
                  <style>
                  /* 自定义下拉菜单样式 */
                  .dropdown-option:hover {
                      background-color: #f8f9fa;
                  }
                  .dropdown-option.selected {
                      background-color: #0d6efd;
                      color: white;
                      font-weight: bold;
                  }
                  .custom-dropdown-btn:focus {
                      outline: none;
                      border-color: #86b7fe;
                      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
                  }
                  </style>
                  
                  <script>
                  // 自定义下拉菜单功能
                  function toggleDropdown(optionsId) {
                      var options = document.getElementById(optionsId);
                      // 关闭其他所有下拉菜单
                      var allOptions = document.querySelectorAll('.custom-dropdown-options');
                      for (var i = 0; i < allOptions.length; i++) {
                          var opt = allOptions[i];
                          if (opt.id !== optionsId) {
                              opt.style.display = 'none';
                          }
                      }
                      // 切换当前下拉菜单
                      options.style.display = options.style.display === 'block' ? 'none' : 'block';
                  }
                  
                  function selectEngineer(element, inputId, optionsId) {
                      // 更新选中状态
                      var options = document.querySelectorAll('#' + optionsId + ' .dropdown-option');
                      for (var i = 0; i < options.length; i++) {
                          options[i].classList.remove('selected');
                      }
                      element.classList.add('selected');
                       // 更新隐藏的input值
                      var input = document.getElementById(inputId);
                      input.value = element.getAttribute('data-value');
                       // 更新显示的文本
                      var selectedText = document.getElementById('selectedEngineer');
                      selectedText.textContent = element.textContent.trim();
                      
                      // 关闭下拉菜单
                      document.getElementById(optionsId).style.display = 'none';
                  }
                  
                  // 点击其他地方关闭下拉菜单
                  document.addEventListener('click', function(event) {
                      if (!event.target.closest('.custom-dropdown')) {
                          var allOptions = document.querySelectorAll('.custom-dropdown-options');
                          for (var i = 0; i < allOptions.length; i++) {
                              allOptions[i].style.display = 'none';
                          }
                      }
                  });
                  </script>
            <div class="form-group col-md-12 form-animation">
              <label class="form-label">
                <i class="fas fa-list-alt mr-2"></i>产品需求 <small class="text-muted">(选填)</small>
              </label>
              <!-- 文字输入区域 -->
              <div class="mb-3 position-relative">
                <textarea class="form-control" id="productRequirementText" name="product_requirement_text" rows="3" 
                  placeholder="请输入产品需求描述（可选，若上传文件则此项可留空）" oninput="validateField(this)"></textarea>
                <div class="field-icon"></div>
              </div>
              <!-- 文件上传区域 -->
              <div class="file-upload-container">
                <label for="productRequirementFile" class="form-label"><i class="fas fa-upload mr-2"></i>或上传需求文件</label>
                <div class="custom-file">
                  <input type="file" class="custom-file-input" id="productRequirementFile" name="product_requirement_file"
                    accept=".doc,.docx,.pdf,.jpg,.jpeg,.png,.gif" onchange="updateFileName(this)">
                  <label class="custom-file-label" for="productRequirementFile">选择文件</label>
                </div>
                <small class="form-text text-muted">支持Word、PDF文档和图片文件</small>
              </div>
            </div>
            <div class="col-12 mt-4 text-right">
              <button type="submit" class="btn btn-primary btn-submit btn-lg px-6 py-2 rounded transition-all duration-300">
                <i class="fas fa-check-circle mr-2"></i>添加产品
              </button>
            </div>
          </form>
    </div>
  </div>

  <!-- 搜索和筛选 -->
  <div class="card mb-6 fade-in">
    <div class="card-header bg-info text-white">
      <h3 class="h6 mb-0"><i class="fas fa-filter mr-2"></i>搜索和筛选</h3>
    </div>
    <div class="card-body">
      <form method="get" action="/products" class="row g-3">
        <div class="form-group col-md-6 form-animation">
          <label for="searchInput" class="form-label">
            <i class="fas fa-search mr-2"></i>搜索产品
          </label>
          <div class="position-relative">
            <input type="text" class="form-control search-input" id="searchInput" name="search" value="{{ search_query }}"
              placeholder="产品名或ID" autocomplete="off">
            <i class="fas fa-search search-icon position-absolute right-3 top-50 transform -translate-y-1/2 text-gray-400"></i>
          </div>
        </div>
        <div class="form-group col-md-4 form-animation">
          <label for="filterEngineer" class="form-label">
            <i class="fas fa-user-filter mr-2"></i>筛选工程师
          </label>
          <select class="form-control select-enhanced" id="filterEngineer" name="engineer_id">
            <option value="">所有工程师</option>
            {% for engineer in engineers %}
            <option value="{{ engineer.id }}" {% if engineer_id==engineer.id|string %}selected{% endif %}>{{
              engineer.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group col-md-2 align-self-end form-animation">
          <button type="submit" class="btn btn-info btn-block search-btn transition-all duration-300">
            <i class="fas fa-search"></i> 搜索
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 产品列表表格 -->
  <div class="card fade-in">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0"><i class="fas fa-boxes mr-2"></i>产品列表</h2>
      <div class="d-flex align-items-center gap-3">
        <!-- 产品类型分页 -->
        <nav aria-label="产品类型分页">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item {% if product_type == 'custom' %}active{% endif %}" id="custom-type-page">
              <a class="page-link" href="#" data-type="custom">定制</a>
            </li>
            <li class="page-item {% if product_type == 'finished' %}active{% endif %}" id="finished-type-page">
              <a class="page-link" href="#" data-type="finished">成品</a>
            </li>
          </ul>
        </nav>
        <span class="badge badge-light">共 {{ total_products }} 个产品</span>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0 table-layout-fixed">
        <thead class="thead-dark">
          <tr>
            <th style="width: 50px;"><input type="checkbox" id="select-all"></th>
            <th style="width: 80px;">产品ID</th>
            <th style="width: 18%;">产品名称</th>
            <th style="width: 100px;">价格</th>
            <th style="width: 120px;">状态</th>
            <th style="width: 13%;">工程师</th>
            <th style="width: 140px;">创建时间</th>
            <th style="width: 13%;">文档</th>
            <th style="width: 180px;">操作</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr {% if product.status == 'abnormal' %}class="table-danger"{% endif %} class="table-row-hover transition-all duration-300">
              <td><input type="checkbox" class="product-select" data-product-id="{{ product.id }}"></td>
              <td>{{ product.id }}</td>
              <td>{{ product.name }}</td>
              <td>{{ product.price if product.price else '未设置' }}</td>
              <td>
                {% if product.images %}
                <div style="display: flex; flex-wrap: wrap; gap: 4px; max-width: 80px;">
                  {% for image in product.images %}
                  <a href="/{{ image.filepath.replace('\\', '/') }}" target="_blank" title="点击查看大图">
                    <img src="/{{ image.filepath.replace('\\', '/') }}" alt="产品图片" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer;">
                  </a>
                  {% endfor %}
                </div>
                {% else %}
                无
                {% endif %}
              </td>
              <td class="status-column">
                <span
                  class="badge {% if product.status == 'completed' %}badge-success{% elif product.status == 'abnormal' %}badge-danger{% elif product.assigned_engineer_id %}badge-primary{% else %}badge-warning{% endif %} px-3 py-1">
                  {% if product.status == 'completed' %}已完成{% elif product.status == 'abnormal' %}无文档（异常）{% elif product.assigned_engineer_id %}进行中{% else %}未开始{% endif %}
                </span>
              {% if product.status != 'not_started' %}
              <span class="d-block d-md-none mt-1">({{ product.reviewed_time.strftime('%Y-%m-%d') if product.status == 'completed' else product.completed_time.strftime('%Y-%m-%d') if product.status == 'pending_review' else product.assigned_time.strftime('%Y-%m-%d') }})</span>
              <div class="status-tooltip d-none d-md-block" title="
                {% if product.status == 'completed' %}审核通过: {{ product.reviewed_time.strftime('%Y-%m-%d') }}
                {% elif product.status == 'pending_review' %}提交审核: {{ product.completed_time.strftime('%Y-%m-%d') }}
                {% else %}分配于: {{ product.assigned_time.strftime('%Y-%m-%d') }}
                {% endif %}">
                <i class="fas fa-info-circle text-muted"></i>
              </div>
              {% endif %}
            </td>
            <td>{{ product.assigned_engineer.name if product.assigned_engineer else '未分配' }}</td>
            <td>{{ (product.created_time + timedelta(hours=8)).strftime('%Y-%m-%d %H:%M') }}</td>
            <!-- 文档列 -->
            <td class="document-cell">
              {% if product.documents %}
                {% for doc in product.documents %}
                <a href="{{ url_for('document_viewer.view_document', document_id=doc.id) }}" class="btn btn-sm btn-info mb-1" target="_blank">
                  <i class="fas fa-file-alt mr-2"></i>{{ doc.filename }}
                </a>
                {% endfor %}
              {% else %}
                <span class="text-muted">无文档</span>
              {% endif %}
            </td>

            <!-- 操作列下拉菜单示例 -->
            <td class="action-buttons">
              <div class="dropdown">
                <button class="btn btn-sm btn-primary dropdown-toggle action-dropdown-btn transition-all duration-300"
                  type="button" data-toggle="dropdown"
                  aria-haspopup="true" aria-expanded="false"
                  title="产品操作菜单">
                  <i class="fas fa-ellipsis-v mr-1"></i>操作
                </button>
                <div class="dropdown-menu dropdown-menu-right shadow-lg dropdown-menu-enhanced" 
                  aria-labelledby="actionDropdown{{ product.id }}">
                  <a class="dropdown-item edit-price" data-product-id="{{ product.id }}" data-current-price="{{ product.price }}" href="#"><i class="fas fa-edit mr-2"></i>编辑价格</a>
                  <a class="dropdown-item assign-engineer" data-product-id="{{ product.id }}" data-current-engineer="{{ product.assigned_engineer_id }}" href="#"><i class="fas fa-user-check mr-2"></i>分配工程师</a>
                  <a class="dropdown-item add-document" data-product-id="{{ product.id }}" href="#"><i class="fas fa-plus mr-2"></i>修改文档</a>
                  {% if product.status == 'not_started' or product.status == 'in_progress' %}
                  <a class="dropdown-item mark-completed" data-product-id="{{ product.id }}" href="#"><i class="fas fa-check-circle mr-2"></i>标记完成</a>
                  {% endif %}
                  {% if product.status == 'pending_review' and current_user.role == 'super_admin' %}
                  <a class="dropdown-item review-product" data-product-id="{{ product.id }}" href="#"><i class="fas fa-clipboard-check mr-2"></i>审核通过</a>
                  {% endif %}
                  {% if current_user.role == 'super_admin' %}
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item delete-product" data-product-id="{{ product.id }}" href="#"><i class="fas fa-trash-alt mr-2"></i>删除产品</a>
                  {% endif %}
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- 分页 -->
    {% if total_pages > 1 %}
    <div class="card-footer bg-light pagination-container">
      <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center pagination-enhanced">
          <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
            <a class="page-link"
              href="{{ url_for('project.projects_management', page=current_page-1, search=search_query, engineer_id=engineer_id) }}"
              aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {% for page_num in range(1, total_pages + 1) %}
          <li class="page-item {% if current_page == page_num %}active{% endif %}">
            <a class="page-link"
              href="{{ url_for('project.projects_management', page=page_num, search=search_query, engineer_id=engineer_id) }}">{{
              page_num }}</a>
          </li>
          {% endfor %}
          <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
            <a class="page-link"
              href="{{ url_for('project.projects_management', page=current_page+1, search=search_query, engineer_id=engineer_id) }}"
              aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
    {% endif %}
    <!-- 批量操作工具栏 -->
    <div class="card-footer bg-light d-flex flex-column flex-md-row justify-content-between align-items-center gap-3 batch-actions-container">
      <div class="showing-info">
        显示 {{ (current_page-1)*per_page + 1 }} 到 {{ [current_page*per_page, total_products]|min }} 条，共 {{ total_products
        }} 条
      </div>
      <div class="batch-actions w-100 w-md-auto" style="display: none;">
        <div class="d-flex flex-wrap gap-2">
          <select id="batch-action-type" class="form-control form-control-sm">
            <option value="">批量操作</option>
            <option value="delete">删除所选</option>
            <option value="assign">分配工程师</option>
          </select>
          <button id="apply-batch-action" class="btn btn-sm btn-primary"><i class="fas fa-check mr-1"></i> 应用</button>
        </div>
      </div>
      <div class="d-flex align-items-center w-100 w-md-auto justify-content-md-end">
        <div class="mr-3">
          每页显示:
          <select id="per-page-select" class="form-control form-control-sm d-inline-block w-auto">
            <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
            <option value="20" {% if per_page==20 %}selected{% endif %}>20</option>
            <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 编辑价格模态框 -->
<div class="modal fade" id="editPriceModal" tabindex="-1" role="dialog" aria-labelledby="editPriceModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPriceModalLabel">编辑产品价格</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editPriceProductId">
        <div class="form-group">
          <label for="newPrice">新价格</label>
          <input type="number" class="form-control" id="newPrice" step="0.01" min="0">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="savePriceBtn">保存</button>
      </div>
    </div>
  </div>
</div>

<div id="assignEngineerModal" class="modal fade">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">分配工程师</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="assignEngineerForm" method="post">
          <input type="hidden" id="assignEngineerProductId" name="project_id">
          <div class="form-group">
                <label for="assignEngineer">选择工程师</label>
                <!-- 自定义工程师选择框 - 分配工程师模态框 -->
                <div class="custom-dropdown" style="position: relative; width: 100%;">
                    <button type="button" class="custom-dropdown-btn" style="
                        width: 100%;
                        padding: 0.375rem 0.75rem;
                        background-color: #fff;
                        border: 1px solid #ced4da;
                        border-radius: 4px;
                        text-align: left;
                        cursor: pointer;
                        font-size: 1rem;
                        line-height: 1.5;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    " onclick="toggleDropdown('assignEngineerOptions')">
                        <span id="selectedAssignEngineer" style="color: #333;">请选择</span>
                        <span style="color: #666;">▼</span>
                    </button>
                    <!-- 下拉选项容器 -->
                    <div id="assignEngineerOptions" class="custom-dropdown-options" style="
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        max-height: 200px;
                        overflow-y: auto;
                        background-color: #fff;
                        border: 1px solid #ced4da;
                        border-top: none;
                        border-radius: 0 0 4px 4px;
                        z-index: 1000;
                        display: none;
                    ">
                        <div 
                            class="dropdown-option" 
                            data-value="" 
                            onclick="selectModalEngineer(this, 'assignEngineerProductId_value', 'selectedAssignEngineer', 'assignEngineerOptions')"
                            style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f8f9fa;"
                        >
                            请选择
                        </div>
                        {% for engineer in engineers %}
                        <div 
                            class="dropdown-option" 
                            data-value="{{ engineer.id }}" 
                            onclick="selectModalEngineer(this, 'assignEngineerProductId_value', 'selectedAssignEngineer', 'assignEngineerOptions')"
                            style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f8f9fa;"
                        >
                            {{ engineer.name }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <script>
                // 模态框中的工程师选择功能
                function selectModalEngineer(element, productIdInputId, selectedTextId, optionsId) {
                    // 更新选中状态
                    const options = document.querySelectorAll('#' + optionsId + ' .dropdown-option');
                    options.forEach(opt => opt.classList.remove('selected'));
                    element.classList.add('selected');
                    
                    // 更新显示的文本
                    const selectedText = document.getElementById(selectedTextId);
                    selectedText.textContent = element.textContent.trim();
                    
                    // 更新隐藏的input值 - 这里我们需要特殊处理，因为模态框表单有自己的提交逻辑
                    const engineerId = element.getAttribute('data-value');
                    
                    // 存储选中的工程师ID，供模态框的提交按钮使用
                    document.getElementById('assignEngineerForm').dataset.engineerId = engineerId;
                    
                    // 关闭下拉菜单
                    document.getElementById(optionsId).style.display = 'none';
                }
                </script>
              <style>
              #engineerSelect option { padding: 5px; height: 30px; }
              #engineerSelect { min-height: 38px; }
            </style>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="assignEngineerBtn"><i class="fas fa-user-check mr-2"></i>
          分配</button>
      </div>
    </div>
  </div>
</div>

<div id="addDocumentModal" class="modal fade">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">修改文档</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="addDocumentForm" method="post" enctype="multipart/form-data">
          <input type="hidden" id="addDocumentProductId" name="project_id">
          <div class="form-group">
            <label for="documentUpload">选择文档</label>
            <input type="file" class="form-control-file" id="documentUpload" name="document" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="uploadDocumentBtn"><i class="fas fa-upload mr-2"></i>更新文档</button>
      </div>
    </div>
  </div>
</div>

<!-- 批量分配工程师模态框 -->
<div id="batchAssignEngineerModal" class="modal fade" tabindex="-1" role="dialog"
  aria-labelledby="batchAssignEngineerModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="batchAssignEngineerModalLabel">批量分配工程师</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="batchAssignEngineerForm" method="post">
          <input type="hidden" id="batchAssignEngineerProductIds" name="product_ids">
          <div class="form-group">
                <label for="batchAssignEngineer">选择工程师</label>
                <!-- 自定义工程师选择框 - 批量分配工程师模态框 -->
                <div class="custom-dropdown" style="position: relative; width: 100%;">
                    <button type="button" class="custom-dropdown-btn" style="
                        width: 100%;
                        padding: 0.375rem 0.75rem;
                        background-color: #fff;
                        border: 1px solid #ced4da;
                        border-radius: 4px;
                        text-align: left;
                        cursor: pointer;
                        font-size: 1rem;
                        line-height: 1.5;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    " onclick="toggleDropdown('batchEngineerOptions')">
                        <span id="selectedBatchEngineer" style="color: #333;">请选择</span>
                        <span style="color: #666;">▼</span>
                    </button>
                    <!-- 下拉选项容器 -->
                    <div id="batchEngineerOptions" class="custom-dropdown-options" style="
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        max-height: 200px;
                        overflow-y: auto;
                        background-color: #fff;
                        border: 1px solid #ced4da;
                        border-top: none;
                        border-radius: 0 0 4px 4px;
                        z-index: 1000;
                        display: none;
                    ">
                        <div 
                            class="dropdown-option" 
                            data-value="" 
                            onclick="selectBatchModalEngineer(this, 'selectedBatchEngineer', 'batchEngineerOptions')"
                            style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f8f9fa;"
                        >
                            请选择
                        </div>
                        {% for engineer in engineers %}
                        <div 
                            class="dropdown-option" 
                            data-value="{{ engineer.id }}" 
                            onclick="selectBatchModalEngineer(this, 'selectedBatchEngineer', 'batchEngineerOptions')"
                            style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f8f9fa;"
                        >
                            {{ engineer.name }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <script>
                // 批量分配模态框中的工程师选择功能
                function selectBatchModalEngineer(element, selectedTextId, optionsId) {
                    // 更新选中状态
                    const options = document.querySelectorAll('#' + optionsId + ' .dropdown-option');
                    options.forEach(opt => opt.classList.remove('selected'));
                    element.classList.add('selected');
                    
                    // 更新显示的文本
                    const selectedText = document.getElementById(selectedTextId);
                    selectedText.textContent = element.textContent.trim();
                    
                    // 更新隐藏的input值 - 这里我们需要特殊处理，因为模态框表单有自己的提交逻辑
                    const engineerId = element.getAttribute('data-value');
                    
                    // 存储选中的工程师ID，供模态框的提交按钮使用
                    document.getElementById('batchAssignEngineerForm').dataset.engineerId = engineerId;
                    
                    // 关闭下拉菜单
                    document.getElementById(optionsId).style.display = 'none';
                }
                </script>
              <style>
                /* 自定义下拉菜单全局样式 */
                .custom-dropdown-options .dropdown-option:hover {
                    background-color: #e9ecef;
                }
                
                .custom-dropdown-options .dropdown-option.selected {
                    background-color: #0d6efd;
                    color: white;
                    font-weight: bold;
                }
                
                /* 确保模态框中的下拉菜单在最上层 */
                .modal .custom-dropdown-options {
                    z-index: 2000;
                }
              </style>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="batchAssignEngineerBtn"><i class="fas fa-user-check mr-1"></i>
          分配</button>
      </div>
    </div>
  </div>
</div>

<script>
$(function() {
    // 使用事件委托绑定分配工程师按钮点击事件
    $(document).on('click', '.assign-engineer', function() {
        const productId = $(this).data('product-id');
        const currentEngineer = $(this).data('current-engineer');
        // 显示分配工程师模态框的代码...
    });

    // 使用事件委托绑定标记完成按钮点击事件
    // 全局toggleDropdown函数
    window.toggleDropdown = function(optionsId) {
        const options = document.getElementById(optionsId);
        if (options) {
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        }
    };

    // 点击外部关闭下拉菜单
    document.addEventListener('click', function(event) {
        const dropdowns = document.querySelectorAll('.custom-dropdown-options');
        dropdowns.forEach(dropdown => {
            if (!dropdown.parentElement.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

    // 修改分配工程师表单提交逻辑
    document.getElementById('assignEngineerBtn').addEventListener('click', function() {
        const form = document.getElementById('assignEngineerForm');
        const productId = document.getElementById('assignEngineerProductId').value;
        const engineerId = form.dataset.engineerId || '';
        
        if (!engineerId) {
            alert('请选择工程师');
            return;
        }
        
        // 提交表单
        $.post('/assign_engineer', {
            project_id: productId,
            engineer_id: engineerId
        }, function(response) {
            if (response.success) {
                $('#assignEngineerModal').modal('hide');
                location.reload();
            } else {
                alert('操作失败: ' + response.error);
            }
        });

    // 修改批量分配工程师表单提交逻辑
    document.getElementById('batchAssignEngineerBtn').addEventListener('click', function() {
        const form = document.getElementById('batchAssignEngineerForm');
        const productIds = document.getElementById('batchAssignEngineerProductIds').value;
        const engineerId = form.dataset.engineerId || '';
        
        if (!engineerId) {
            alert('请选择工程师');
            return;
        }
        
        // 提交表单
        $.post('/batch_assign_engineer', {
            product_ids: productIds,
            engineer_id: engineerId
        }, function(response) {
            if (response.success) {
                $('#batchAssignEngineerModal').modal('hide');
                location.reload();
            } else {
                alert('操作失败: ' + response.error);
            }
        });

    $(document).on('click', '.mark-completed', function() {
        var productId = $(this).data('product-id');
        if (confirm('确定要标记此产品为完成状态吗？')) {
            $.post('/mark_completed/' + productId, function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('操作失败: ' + response.error);
                }
            });
        }
    });

    // 使用事件委托绑定删除产品按钮点击事件
    $(document).on('click', '.delete-product', function() {
        var productId = $(this).data('product-id');
        if (confirm('确定要删除此产品吗？此操作不可撤销！')) {
            $.post('/delete_product/' + productId, function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('操作失败: ' + response.error);
                }
            });
        }
    });

    // 编辑价格按钮点击事件
    $(document).on('click', '.edit-price', function() {
        var productId = $(this).data('product-id');
        var currentPrice = $(this).data('current-price');

        // 设置模态框中的产品ID和当前价格
        $('#editPriceProductId').val(productId);
        $('#newPrice').val(currentPrice || '');

        // 显示模态框
        $('#editPriceModal').modal('show');
    });

    // 保存价格按钮点击事件
    $('#savePriceBtn').click(function() {
        const productId = $('#editPriceProductId').val();
        const newPrice = $('#newPrice').val();

        // 验证价格
        if (newPrice === '' || isNaN(parseFloat(newPrice))) {
            alert('请输入有效的价格');
            return;
        }

        // 发送POST请求更新价格
        $.post(`/update_price/${productId}`, { price: newPrice }, function(response) {
            if (response.success) {
                $('#editPriceModal').modal('hide');
                location.reload();
            } else {
                alert('更新失败: ' + response.error);
            }
        });

    // 分配工程师按钮点击事件
    $(document).ready(function() {
      // 使用事件委托确保动态加载的元素也能绑定事件
      $(document).on('click', '.assign-engineer', function(e) {
        e.preventDefault();
        const productId = $(this).data('product-id');
        const currentEngineer = $(this).data('current-engineer');
    
        // 设置当前产品ID到模态框
        $('#assignEngineerProductId').val(productId);
        
        // 如果已有工程师，选中对应选项
        if (currentEngineer) {
            $('#engineerSelect').val(currentEngineer);
        }
    
        // 显示模态框
        $('#assignEngineerModal').modal('show');
    });

    // 确保标记完成按钮事件正确绑定
    $(document).on('click', '.mark-completed', function(e) {
      e.preventDefault();
      const productId = $(this).data('product-id');
    
      if (confirm('确定要标记此产品为完成状态吗？')) {
        $.post(`/mark_completed/${productId}`, {
          csrf_token: '{{ csrf_token() }}'
        }).done(function() {
          location.reload();
        }).fail(function(xhr) {
          alert(xhr.responseJSON ? xhr.responseJSON.error : '操作失败，请重试');
        });
      }
    });

    // 确保删除产品按钮事件正确绑定
    $(document).on('click', '.delete-product', function(e) {
      e.preventDefault();
      const productId = $(this).data('product-id');
      const productName = $(this).closest('tr').find('td:nth-child(2)').text().trim();
    
      if (confirm(`确定要删除产品 ${productName} 及其所有文档吗？`)) {
        $.post(`/delete_product/${productId}`, {
          csrf_token: '{{ csrf_token() }}'
        }).done(function() {
          location.reload();
        }).fail(function(xhr) {
          alert(xhr.responseJSON ? xhr.responseJSON.error : '删除失败，请重试');
        });
      }
    });

    // 为表格行设置z-index，确保上面的行z-index高于下面的行
    const rows = $('.table tbody tr');
    rows.each(function (index) {
      $(this).css({
        'position': 'relative',
        'z-index': 1000 - index
      });
    });

    // 自定义下拉菜单处理
    $('.dropdown-toggle').on('click', function (e) {
      e.preventDefault();
      e.stopPropagation();

      // 关闭其他所有下拉菜单
      $('.dropdown-menu').removeClass('show');

      // 获取当前下拉菜单
      const $dropdown = $(this).closest('.dropdown');
      const $menu = $dropdown.find('.dropdown-menu');
      const $row = $dropdown.closest('tr');
      const rowIndex = $row.index();

      // 为下拉菜单设置高z-index，确保始终在表格行之上
      const menuZIndex = 2000 + (100 - rowIndex);

      // 设置下拉菜单和按钮的z-index关系
      $menu.css('z-index', menuZIndex);
      $(this).css('z-index', menuZIndex - 1); // 按钮z-index比菜单低1

      // 强制向上展开
      $menu.css({
        top: 'auto',
        bottom: '100%',
        marginBottom: '5px'
      });

      // 显示下拉菜单
      $menu.addClass('show');
    });

    // 点击其他地方关闭下拉菜单
    $(document).on('click', function (e) {
      if (!$(e.target).closest('.dropdown').length) {
        $('.dropdown-menu.show').removeClass('show');
      }
    });
  });
  // 添加文档按钮点击事件
  $('.add-document').click(function (e) {
    e.preventDefault();
    const productId = $(this).data('product-id');
    $('#addDocumentProductId').val(productId);
    $('#addDocumentModal').modal('show');
  });

  // 上传文档按钮点击事件 - 修复URL路径
  $('#uploadDocumentBtn').click(function() {
    const productId = $('#addDocumentProductId').val();
    const formData = new FormData($('#addDocumentForm')[0]);
  
    $.ajax({
      url: `/add_document/${productId}`,
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function() {
        $('#addDocumentModal').modal('hide');
        location.reload();
      },
      error: function(xhr) {
        // 显示后端返回的错误信息
        alert(xhr.responseJSON ? xhr.responseJSON.error : '上传失败，请重试');
      }
    });
  });

  // 添加标记完成功能
  $('.mark-completed').click(function (e) {
    e.preventDefault();
    const productId = $(this).data('product-id');

    if (confirm('确定要标记此产品为完成状态吗？')) {
      $.post(`/mark_completed/${productId}`, {
        csrf_token: '{{ csrf_token() }}'
      }).done(function () {
        $('#assignEngineerModal').modal('hide');
        location.reload();
      }).fail(function (xhr) {
        // 显示后端返回的错误信息
        alert(xhr.responseJSON ? xhr.responseJSON.error : '操作失败，请重试');
      });
    }
  });

  // 全选功能
  $('#select-all').click(function () {
    const isChecked = $(this).prop('checked');
    $('.product-select').prop('checked', isChecked);
    updateBatchActionsVisibility();
  });

  // 单个选择框点击事件
  $('.product-select').click(function () {
    const allChecked = $('.product-select:checked').length === $('.product-select').length;
    $('#select-all').prop('checked', allChecked);
    updateBatchActionsVisibility();
  });

  // 更新批量操作工具栏可见性
  function updateBatchActionsVisibility() {
    const checkedCount = $('.product-select:checked').length;
    if (checkedCount > 0) {
      $('.batch-actions').show();
    } else {
      $('.batch-actions').hide();
    }
  }

  // 应用批量操作
  $('#apply-batch-action').click(function () {
    const actionType = $('#batch-action-type').val();
    const checkedProducts = $('.product-select:checked');
    const productIds = checkedProducts.map(function () {
      return $(this).data('product-id');
    }).get();

    if (!actionType || productIds.length === 0) {
      return;
    }

    if (actionType === 'delete') {
      if (confirm(`确定要删除选中的 ${productIds.length} 个产品吗？`)) {
        $.post('/delete_products', {
          product_ids: JSON.stringify(productIds),
          csrf_token: '{{ csrf_token() }}'
        }).done(function () {
          location.reload();
        }).fail(function () {
          alert('删除失败，请重试');
        });
      }
    } else if (actionType === 'assign') {
      $('#batchAssignEngineerProductIds').val(JSON.stringify(productIds));
      $('#batchAssignEngineerModal').modal('show');
    }
  });

  // 批量分配工程师按钮点击事件
  $('#batchAssignEngineerBtn').click(function () {
    const productIds = $('#batchAssignEngineerProductIds').val();
    const engineerId = $('#batchEngineerSelect').val();

    if (!engineerId) {
      alert('请选择工程师');
      return;
    }

    $.post('/assign_engineer_batch', {
      product_ids: productIds,
      engineer_id: engineerId,
      csrf_token: '{{ csrf_token() }}'
    }).done(function () {
      $('#batchAssignEngineerModal').modal('hide');
      location.reload();
    }).fail(function () {
      alert('分配失败，请重试');
    });
  });

  // 每页显示数量更改
  $('#per-page-select').change(function () {
    const perPage = $(this).val();
    const currentUrl = window.location.href;
    const newUrl = updateQueryStringParameter(currentUrl, 'per_page', perPage);
    window.location.href = newUrl;
  });

  function updateQueryStringParameter(uri, key, value) {
    const re = new RegExp(`([?&])${key}=.*?(&|$)`, 'i');
    const separator = uri.indexOf('?') !== -1 ? '&' : '?';
    if (uri.match(re)) {
      return uri.replace(re, `$1${key}=${value}$2`);
    } else {
      return uri + separator + `${key}=${value}`;
    }
  }
  // 删除产品按钮点击事件
  $('.delete-product').click(function (e) {
    e.preventDefault();
    const productId = $(this).data('product-id');
    // 获取产品名称
    const productName = $(this).closest('tr').find('td:nth-child(2)').text().trim();
  
    if (confirm(`确定要删除产品 ${productName} 及其所有文档吗？`)) {
      $.post(`/delete_product/${productId}`, {
        csrf_token: '{{ csrf_token() }}'
      }).done(function () {
        location.reload();
      }).fail(function (xhr) {
        // 显示后端返回的错误信息
        alert(xhr.responseJSON ? xhr.responseJSON.error : '删除失败，请重试');
      });
    }
  });

  $(function () {
    // 分配工程师按钮点击事件
    $('#assignEngineerBtn').click(function () {
      const productId = $('#assignEngineerProductId').val();
      const engineerId = $('#engineerSelect').val();

      if (!engineerId) {
        alert('请选择工程师');
        return;
      }

      $.post(`/assign_engineer/${productId}`, {
        engineer_id: engineerId,
        csrf_token: '{{ csrf_token() }}'
      }).done(function () {
        $('#assignEngineerModal').modal('hide');
        location.reload();
      }).fail(function (xhr) {
        alert(xhr.responseJSON ? xhr.responseJSON.error : '分配失败，请重试');
      });
    });
  });
  
  // 产品类型分页切换 - 使用后端筛选
  $(document).on('click', '#finished-type-page a, #custom-type-page a', function(e) {
    e.preventDefault();
    const type = $(this).data('type');
    
    // 更新分页按钮状态
    $('#finished-type-page, #custom-type-page').removeClass('active');
    $(this).parent().addClass('active');
    
    // 构建URL查询参数
    const currentUrl = window.location.href;
    const baseUrl = currentUrl.split('?')[0];
    const urlParams = new URLSearchParams(window.location.search);
    
    // 更新产品类型参数
    urlParams.set('product_type', type);
    urlParams.set('page', 1); // 重置到第一页
    
    // 重新加载页面
    window.location.href = `${baseUrl}?${urlParams.toString()}`;
  });
  
  // 添加产品表单的类型分页切换（保留原有功能）
  
  // 根据URL参数设置活动标签
  $(document).ready(function() {
    // 从URL获取产品类型参数
    const urlParams = new URLSearchParams(window.location.search);
    const productType = urlParams.get('product_type') || 'custom';
    
    // 设置对应的标签为活动状态
    $('#finished-type-page, #custom-type-page').removeClass('active');
    if (productType === 'finished') {
      $('#finished-type-page').addClass('active');
    } else if (productType === 'custom') {
      $('#custom-type-page').addClass('active');
    }
  });
  
  // 添加产品表单的类型分页切换
  $(document).on('click', '#add-finished-type a, #add-custom-type a', function(e) {
    e.preventDefault();
    const type = $(this).data('type');
    
    // 更新分页按钮状态
    $('#add-finished-type, #add-custom-type').removeClass('active');
    $(this).parent().addClass('active');
    
    // 更新隐藏字段的值
    $('#productType').val(type);
    
    // 切换显示对应的表单内容并禁用/启用输入框
    if (type === 'finished') {
      $('#finished-product-form').show();
      $('#finished-product-form input, #finished-product-form select').prop('disabled', false);
      $('#custom-product-form').hide();
      $('#custom-product-form input, #custom-product-form select').prop('disabled', true);
    } else {
      $('#finished-product-form').hide();
      $('#finished-product-form input, #finished-product-form select').prop('disabled', true);
      $('#custom-product-form').show();
      $('#custom-product-form input, #custom-product-form select').prop('disabled', false);
    }
  });
  
  // 页面加载时初始化表单状态
  $(document).ready(function() {
    // 默认启用定制表单，禁用成品表单
    $('#finished-product-form input, #finished-product-form select').prop('disabled', true);
    $('#custom-product-form input, #custom-product-form select').prop('disabled', false);
  });
  
  // 审核产品
  $(document).on('click', '.review-product', function(e) {
    e.preventDefault();
    const productId = $(this).data('product-id');
    if (confirm('确定审核通过此产品吗？')) {
        $.post(`/review_product/${productId}`, function(data) {
            location.reload();
        }).fail(function(xhr) {
            alert('审核失败: ' + xhr.responseJSON.error);
        });
}
    });
  });
});
});
});
});
</script>
<style>
  /* 自定义工程师选择框样式 */
  .engineer-select-wrapper {
      position: relative;
  }
  .engineer-select-wrapper select {
      max-height: 300px;
  }
  /* 覆盖Bootstrap和浏览器默认样式 */
  .engineer-select-wrapper select:focus + .select-dropdown {
      display: block;
  }
  /* 针对下拉菜单的样式 */
  .engineer-select {
      appearance: auto;
      -webkit-appearance: auto;
      -moz-appearance: auto;
  }
  /* 确保下拉选项有滚动效果 */
  .engineer-select option {
      max-height: 300px;
      overflow-y: auto;
  }
  
  /* 重置所有可能影响下拉菜单的样式 */
  .table-responsive,
  .card-body,
  .card,
  .table,
  tbody,
  tr,
  td {
    overflow: visible !important;
    position: static !important;
    z-index: auto !important;
  }

  /* 为下拉菜单容器设置高优先级定位 */
  .table .dropdown {
    position: relative !important;
    z-index: 1500 !important;
    transform: translateZ(0);
    /* 创建新的层叠上下文 */
  }

  /* 确保按钮不会覆盖下拉菜单 - 基础样式 */
  .table .dropdown-toggle {
    position: relative !important;
    z-index: 1 !important;
    /* 默认值，会被JS动态覆盖 */
  }

  /* 表格行悬停效果 */
  .table-row-hover:hover {
    background-color: rgba(74, 144, 226, 0.05) !important;
    transform: scale(1.005) !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
  }

  /* 下拉菜单样式增强 */
  .dropdown-menu-enhanced {
    min-width: 180px !important;
    border-radius: 8px !important;
    padding: 0.5rem 0 !important;
    margin-top: 4px !important;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15) !important;
    border: 1px solid #e9ecef !important;
    overflow: hidden !important;
    transition: all 0.3s ease !important;
  }

  .dropdown-menu-enhanced .dropdown-item {
    padding: 0.75rem 1.5rem !important;
    transition: all 0.2s ease !important;
    border-left: 3px solid transparent !important;
  }

  .dropdown-menu-enhanced .dropdown-item:hover {
    background-color: #f8f9fa !important;
    border-left-color: #4a90e2 !important;
    padding-left: 1.75rem !important;
  }

  .dropdown-menu-enhanced .dropdown-item i {
    margin-right: 0.75rem !important;
    width: 1.25rem !important;
    text-align: center !important;
  }

  /* 操作按钮增强 */
  .action-dropdown-btn {
    padding: 0.375rem 0.75rem !important;
    font-size: 0.875rem !important;
    border-radius: 6px !important;
  }

  .action-dropdown-btn:hover {
    background-color: #0d6efd !important;
    transform: translateY(-1px) !important;
  }

  /* 搜索输入框样式 */
  .search-input {
    padding-right: 2.5rem !important;
    border-radius: 6px !important;
    transition: all 0.3s ease !important;
  }

  .search-input:focus {
    border-color: #4a90e2 !important;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1) !important;
  }

  .search-icon {
    pointer-events: none !important;
    transition: color 0.3s ease !important;
  }

  /* 搜索按钮样式 */
  .search-btn:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3) !important;
  }

  /* 选择框增强 */
  .select-enhanced {
    border-radius: 6px !important;
    transition: all 0.3s ease !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
    background-repeat: no-repeat !important;
    background-position: right 0.75rem center !important;
    background-size: 16px 12px !important;
  }

  .select-enhanced:focus {
    border-color: #4a90e2 !important;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1) !important;
  }

  /* 分页样式增强 */
  .pagination-enhanced {
    gap: 4px !important;
  }

  .pagination-enhanced .page-item .page-link {
    border-radius: 6px !important;
    transition: all 0.3s ease !important;
    min-width: 36px !important;
    text-align: center !important;
  }

  .pagination-enhanced .page-item.active .page-link {
    background-color: #4a90e2 !important;
    border-color: #4a90e2 !important;
  }

  .pagination-enhanced .page-item:not(.active) .page-link:hover {
    background-color: #f8f9fa !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
  }

  /* 文件上传样式 */
  .custom-file {
    position: relative !important;
    display: inline-block !important;
    width: 100% !important;
    height: calc(1.5em + 0.75rem + 2px) !important;
  }

  .custom-file-input {
    position: relative !important;
    z-index: 2 !important;
    width: 100% !important;
    height: calc(1.5em + 0.75rem + 2px) !important;
    margin: 0 !important;
    opacity: 0 !important;
    cursor: pointer !important;
  }

  .custom-file-label {
    position: absolute !important;
    top: 0 !important;
    right: 0 !important;
    left: 0 !important;
    z-index: 1 !important;
    height: calc(1.5em + 0.75rem + 2px) !important;
    padding: 0.375rem 0.75rem !important;
    font-weight: 400 !important;
    line-height: 1.5 !important;
    color: #495057 !important;
    background-color: #fff !important;
    border: 1px solid #ced4da !important;
    border-radius: 0.25rem !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    transition: all 0.3s ease !important;
  }

  .custom-file-input:lang(en) ~ .custom-file-label::after {
    content: "Browse" !important;
  }

  .custom-file-input:lang(zh-CN) ~ .custom-file-label::after,
  .custom-file-input:lang(zh) ~ .custom-file-label::after {
    content: "选择文件" !important;
  }

  .custom-file-label::after {
    position: absolute !important;
    top: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    z-index: 3 !important;
    display: block !important;
    height: calc(1.5em + 0.75rem) !important;
    padding: 0.375rem 0.75rem !important;
    line-height: 1.5 !important;
    color: #495057 !important;
    content: "选择文件" !important;
    background-color: #e9ecef !important;
    border-left: inherit !important;
    border-radius: 0 0.25rem 0.25rem 0 !important;
    transition: all 0.3s ease !important;
  }

  .custom-file-input:focus ~ .custom-file-label {
    border-color: #4a90e2 !important;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1) !important;
  }

  /* 模态框样式增强 */
  .modal-content {
    border-radius: 12px !important;
    border: none !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15) !important;
    overflow: hidden !important;
  }

  .modal-header {
    background-color: #4a90e2 !important;
    color: white !important;
    padding: 1rem 1.5rem !important;
  }

  .modal-title {
    font-weight: 600 !important;
  }

  /* 通用动画类 */
  .transition-all {
    transition: all 0.3s ease !important;
  }

  .duration-300 {
    transition-duration: 0.3s !important;
  }

  /* 修复表格布局 */
  .table th,
  .table td {
    vertical-align: middle !important;
  }

  /* 操作列样式 */
  .table th:last-child,
  .table td:last-child {
    white-space: nowrap !important;
    width: 180px !important;
    position: relative !important;
  }

  /* 文档列样式 */
  .document-cell {
    position: relative !important;
    z-index: 10 !important;
  }

  /* 批量操作容器样式 */
  .batch-actions-container {
    border-top: 1px solid #e9ecef !important;
    margin-top: 0 !important;
    padding-top: 1rem !important;
  }

  /* 分页容器样式 */
  .pagination-container {
    border-bottom: none !important;
  }
</style>
  <script type="text/javascript">
    // 表单验证函数
    function validateProductForm() {
      const form = document.querySelector('form');
      const errors = [];
      
      // 验证必填字段
      const requiredFields = [
        {id: 'product_name', name: '产品名称'},
        {id: 'product_price', name: '产品价格'}
      ];
      
      requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element && !element.value.trim()) {
          errors.push(`${field.name}不能为空`);
          highlightFieldError(element);
        }
      });
      
      // 验证数字字段
      const numberFields = [
        {id: 'product_price', name: '产品价格'},
        {id: 'product_cost', name: '产品成本'},
        {id: 'product_unit_price', name: '产品单价'},
        {id: 'product_total_price', name: '产品总价'}
      ];
      
      numberFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element && element.value.trim() && isNaN(parseFloat(element.value.trim()))) {
          errors.push(`${field.name}必须是数字`);
          highlightFieldError(element);
        }
      });
      
      // 显示错误信息
      if (errors.length > 0) {
        showFormErrors(errors);
        return false;
      }
      
      return true;
    }
    
    // 字段验证函数
    function validateField(field) {
      // 移除之前的错误样式
      field.classList.remove('is-invalid');
      field.classList.add('is-valid');
      
      // 获取相关的错误提示元素
      const errorElement = field.parentNode.querySelector('.invalid-feedback');
      if (errorElement) {
        errorElement.remove();
      }
      
      // 针对不同类型的字段进行特定验证
      if (field.type === 'number' || field.id.includes('price') || field.id.includes('cost')) {
        if (field.value.trim() && isNaN(parseFloat(field.value.trim()))) {
          showFieldError(field, '请输入有效的数字');
        }
      }
    }
    
    // 显示字段错误
    function showFieldError(field, message) {
      field.classList.remove('is-valid');
      field.classList.add('is-invalid');
      
      // 移除已存在的错误提示
      const existingError = field.parentNode.querySelector('.invalid-feedback');
      if (existingError) {
        existingError.remove();
      }
      
      // 添加新的错误提示
      const errorElement = document.createElement('div');
      errorElement.className = 'invalid-feedback';
      errorElement.textContent = message;
      field.parentNode.appendChild(errorElement);
    }
    
    // 高亮显示有错误的字段
    function highlightFieldError(field) {
      field.classList.add('is-invalid');
      field.classList.remove('is-valid');
      
      // 滚动到第一个错误字段
      field.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // 添加抖动动画
      field.classList.add('error-shake');
      setTimeout(() => {
        field.classList.remove('error-shake');
      }, 500);
    }
    
    // 显示表单错误信息
    function showFormErrors(errors) {
      // 移除已存在的错误区域
      let errorContainer = document.getElementById('form-error-messages');
      if (!errorContainer) {
        errorContainer = document.createElement('div');
        errorContainer.id = 'form-error-messages';
        errorContainer.className = 'alert alert-danger alert-dismissible fade show mt-3';
        errorContainer.role = 'alert';
        
        // 添加关闭按钮
        const closeButton = document.createElement('button');
        closeButton.type = 'button';
        closeButton.className = 'close';
        closeButton.setAttribute('data-dismiss', 'alert');
        closeButton.setAttribute('aria-label', 'Close');
        closeButton.innerHTML = '\u003cspan aria-hidden="true"\u003e\u0026times;\u003c/span\u003e';
        errorContainer.appendChild(closeButton);
        
        // 错误信息列表
        const errorList = document.createElement('ul');
        errorList.className = 'mb-0';
        errorContainer.appendChild(errorList);
        
        // 将错误容器添加到表单顶部
        var form = document.querySelector('form');
        form.insertBefore(errorContainer, form.firstChild);
      }
      
      // 更新错误信息
      var errorList = errorContainer.querySelector('ul');
      errorList.innerHTML = '';
      
      for (var i = 0; i < errors.length; i++) {
        var error = errors[i];
        var li = document.createElement('li');
        li.textContent = error;
        errorList.appendChild(li);
      }
      
      // 添加显示动画
      errorContainer.classList.add('show');
      
      // 滚动到错误区域
      errorContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // 工程师下拉菜单交互增强
    function enhanceEngineerDropdown() {
      var dropdowns = document.querySelectorAll('.engineer-selector .dropdown');
      
      for (var i = 0; i < dropdowns.length; i++) {
        var dropdown = dropdowns[i];
        var dropdownToggle = dropdown.querySelector('.dropdown-toggle');
        var dropdownMenu = dropdown.querySelector('.dropdown-menu');
        var dropdownItems = dropdown.querySelectorAll('.dropdown-item');
        var selectedEngineer = dropdown.querySelector('.selected-engineer');
        
        // 点击外部关闭下拉菜单
        document.addEventListener('click', function(e) {
          var currentDropdown = dropdown; // 保存当前dropdown引用
          var currentDropdownMenu = dropdownMenu;
          return function(e) {
            if (!currentDropdown.contains(e.target)) {
              currentDropdownMenu.classList.remove('show');
            }
          };
        }());
        
        // 点击下拉菜单项
        dropdownItems.forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const engineerId = item.getAttribute('data-engineer-id');
            const engineerName = item.textContent.trim();
            
            // 更新隐藏输入值和显示文本
            const hiddenInput = dropdown.querySelector('input[type="hidden"]');
            if (hiddenInput) {
              hiddenInput.value = engineerId;
            }
            
            if (selectedEngineer) {
              selectedEngineer.textContent = engineerName;
            }
            
            // 关闭下拉菜单
            dropdownMenu.classList.remove('show');
          });
        });
      }

    // 文件上传预览
    function setupFilePreview() {
      const fileInputs = document.querySelectorAll('input[type="file"]');
      
      fileInputs.forEach(input => {
        input.addEventListener('change', function() {
          const label = this.nextElementSibling;
          if (label && label.classList.contains('custom-file-label')) {
            const fileName = this.files.length > 0 ? this.files[0].name : '选择文件';
            label.textContent = fileName;
          }
        });
      });
    }
    
    // 批量选择功能
    function setupBatchSelection() {
      const selectAllCheckbox = document.getElementById('select-all-products');
      const productCheckboxes = document.querySelectorAll('.product-select');
      
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
          productCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
          });
        });
      }
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化表单验证
      const forms = document.querySelectorAll('form');
      forms.forEach(form => {
        form.addEventListener('submit', function(e) {
          if (!validateProductForm()) {
            e.preventDefault();
          }
        });
      });
      
      // 添加字段输入验证
      const formInputs = document.querySelectorAll('input, select, textarea');
      formInputs.forEach(input => {
        input.addEventListener('input', function() {
          validateField(this);
        });
      });
      
      // 初始化工程师下拉菜单增强
      enhanceEngineerDropdown();
      
      // 设置文件上传预览
      setupFilePreview();
      
      // 设置批量选择
      setupBatchSelection();
    }
});
</script>
  <style type="text/css">
    /* 表单验证样式 */
    .form-control.is-invalid {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    
    .form-control.is-valid {
      border-color: #28a745 !important;
      box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
    }
    
    .invalid-feedback {
      display: block !important;
      margin-top: 0.25rem !important;
      font-size: 80% !important;
      color: #dc3545 !important;
    }
    
    /* 错误抖动动画 */
    .error-shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      transform: translate3d(0, 0, 0);
      backface-visibility: hidden;
      perspective: 1000px;
    }
    
    @keyframes shake {
      10%, 90% {
        transform: translate3d(-1px, 0, 0);
      }
      20%, 80% {
        transform: translate3d(2px, 0, 0);
      }
      30%, 50%, 70% {
        transform: translate3d(-4px, 0, 0);
      }
      40%, 60% {
        transform: translate3d(4px, 0, 0);
      }
    }
    
    /* 表单动画 */
    .form-animation {
      animation: formSlideIn 0.5s ease-out;
    }
    
    @keyframes formSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    /* 卡片淡入动画 */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    /* 表单字段图标定位 */
    .field-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
      z-index: 10;
    }
    
    /* 表单字段填充内容时的焦点状态 */
    .form-control:focus + .field-icon {
      color: #4a90e2;
    }
  </style>

{% endblock %}