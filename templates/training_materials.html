{% extends "base.html" %}

{% block title %}
  {% if current_user.role == 'engineer' or (hasattr(current_user, 'role_detail') and current_user.role_detail == 'engineer') or (hasattr(current_user, 'role_level') and current_user.role_level == 3) %}
    å·¥ç¨‹å¸ˆæ•™å­¦èµ„æ–™ - èµ„æ–™æ•´ç†ç³»ç»Ÿ
  {% else %}
    åŸ¹è®­èµ„æ–™ - è¯•å²—å‘˜å·¥ä¸“åŒº
  {% endif %}
{% endblock %}

{% block page_title %}èµ„æ–™{% endblock %}

{% block content %}
<!-- è§†é¢‘æ’­æ”¾å™¨æ¨¡æ€æ¡† -->
<div class="modal fade" id="videoPlayerModal" tabindex="-1" role="dialog" aria-labelledby="videoPlayerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="videoPlayerModalLabel">è§†é¢‘æ’­æ”¾</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="video-container">
          <video id="videoPlayer" controls preload="metadata" playsinline crossorigin="anonymous">
            <source src="" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
          </video>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<!-- æ–‡æ¡£æŸ¥çœ‹å™¨æ¨¡æ€æ¡† -->
<div class="modal fade" id="documentViewerModal" tabindex="-1" role="dialog" aria-labelledby="documentViewerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="documentViewerModalLabel">æ–‡æ¡£æŸ¥çœ‹</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="document-container">
          <iframe id="documentViewer" class="w-100" frameborder="0"></iframe>
          <p id="documentFallback" class="text-center text-gray-500 mt-5">
            æ–‡æ¡£æ— æ³•åœ¨æµè§ˆå™¨ä¸­ç›´æ¥æŸ¥çœ‹ï¼Œ<a href="" target="_blank">ç‚¹å‡»æ­¤å¤„ä¸‹è½½</a>ã€‚
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <a id="documentDownloadLink" href="" target="_blank" class="btn btn-secondary mr-2">ä¸‹è½½æ–‡æ¡£</a>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ç®€åŒ–çš„æ–‡æœ¬å¤„ç†å‡½æ•°
  function renderText(text) {
    return text;
  }

  // è®¡ç®—å¹¶æ›´æ–°å­¦ä¹ è¿›åº¦ - ç®€åŒ–ç‰ˆæœ¬
  function updateProgress() {
    // ç”±äºç§»é™¤äº†å¿…å­¦/åŸºç¡€/è¿›é˜¶ç­›é€‰ï¼Œç®€åŒ–ä¸ºåªå¤„ç†å¤é€‰æ¡†çŠ¶æ€ä¿å­˜
    // å®é™…è¿›åº¦è®¡ç®—å¯ä»¥åœ¨åç«¯æˆ–éœ€è¦æ—¶é‡æ–°å®ç°
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åŠŸèƒ½
  document.addEventListener('DOMContentLoaded', function() {
    // ç”±äºç§»é™¤äº†è¿›åº¦æ˜¾ç¤ºï¼Œä¸å†éœ€è¦åˆå§‹åŒ–è¿›åº¦
    
    // ç§»é™¤äº†å®ŒæˆçŠ¶æ€å¤é€‰æ¡†åŠŸèƒ½

    // è§†é¢‘æ’­æ”¾æ¨¡æ€æ¡†åŠŸèƒ½
    var videoModal = $('#videoPlayerModal');
    var videoPlayer = document.getElementById('videoPlayer');
    var videoTitle = document.getElementById('videoPlayerModalLabel');
    
    // è§†é¢‘æ’­æ”¾ä¼˜åŒ–å‡½æ•°
    function optimizeVideoPlayback() {
      const videoElements = videoModal.querySelectorAll('video');
      videoElements.forEach(function(video) {
        video.preload = 'metadata';
        video.addEventListener('loadedmetadata', function() {
          const aspectRatio = video.videoWidth / video.videoHeight;
          const containerWidth = video.parentElement.offsetWidth;
          const optimalHeight = containerWidth / aspectRatio;
          video.style.width = '100%';
          video.style.height = optimalHeight + 'px';
        });
      });
    }
    
    // ä¸ºæ‰€æœ‰è§†é¢‘é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
    var videoLinks = document.querySelectorAll('.video-link');
    for (var i = 0; i < videoLinks.length; i++) {
      var link = videoLinks[i];
      link.addEventListener('click', function(e) {
        e.preventDefault();
        var videoUrl = this.getAttribute('data-video-url') || this.href;
        var videoName = this.textContent;
        
        // è®¾ç½®è§†é¢‘æºå’Œæ ‡é¢˜
        videoPlayer.src = videoUrl;
        videoTitle.textContent = videoName;
        
        // ä¼˜åŒ–è§†é¢‘æ’­æ”¾è®¾ç½®
        optimizeVideoPlayback();
        
        // æ‰“å¼€æ¨¡æ€æ¡†
        videoModal.modal('show');
      });
    }
    
    // æ¨¡æ€æ¡†å…³é—­æ—¶é‡ç½®è§†é¢‘
    videoModal.on('hidden.bs.modal', function() {
      videoPlayer.pause();
      videoPlayer.src = '';
      videoPlayer.load();
    });
    
    // æ¨¡æ€æ¡†æ˜¾ç¤ºåç¡®ä¿è§†é¢‘å®¹å™¨æœ‰è¶³å¤Ÿç©ºé—´
    videoModal.on('shown.bs.modal', function() {
      var videoContainer = document.querySelector('.video-container');
      if (videoContainer) {
        // ç¡®ä¿è§†é¢‘å®¹å™¨é«˜åº¦è¶³å¤Ÿ
        var windowHeight = window.innerHeight;
        var modalHeader = this.querySelector('.modal-header');
        var modalFooter = this.querySelector('.modal-footer');
        
        var headerHeight = modalHeader ? modalHeader.offsetHeight : 0;
        var footerHeight = modalFooter ? modalFooter.offsetHeight : 0;
        
        // è®¾ç½®è§†é¢‘å®¹å™¨æœ€å¤§é«˜åº¦ï¼Œç•™å‡ºä¸€äº›è¾¹è·
        var maxHeight = windowHeight * 0.7;
        videoContainer.style.maxHeight = maxHeight + 'px';
      }
    });
    
    // æ–‡æ¡£æŸ¥çœ‹å™¨æ¨¡æ€æ¡†åŠŸèƒ½
    var docModal = $('#documentViewerModal');
    var docViewer = document.getElementById('documentViewer');
    var docTitle = document.getElementById('documentViewerModalLabel');
    var docFallback = document.getElementById('documentFallback');
    var docDownloadLink = document.getElementById('documentDownloadLink');
    var docFallbackLink = docFallback.querySelector('a');
    
    // æ”¯æŒåœ¨æµè§ˆå™¨ä¸­ç›´æ¥é¢„è§ˆçš„æ–‡ä»¶ç±»å‹
    var previewableTypes = [
      'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'md',
      'jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'
    ];
    
    // ä¸ºæ‰€æœ‰æ–‡æ¡£é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
    var docLinks = document.querySelectorAll('a.text-blue-600');
    for (var i = 0; i < docLinks.length; i++) {
      var link = docLinks[i];
      // ç¡®ä¿è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶é“¾æ¥ï¼ˆä¸æ˜¯é”šç‚¹æˆ–å…¶ä»–é“¾æ¥ï¼‰
      if (link.getAttribute('href') && link.getAttribute('href').startsWith('/')) {
        link.addEventListener('click', function(e) {
          // å¦‚æœæ˜¯è§†é¢‘é“¾æ¥ï¼Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆè®©è§†é¢‘æ’­æ”¾å™¨å¤„ç†ï¼‰
          if (this.classList.contains('video-link')) {
            return;
          }
          
          e.preventDefault();
          var docUrl = this.href;
          var docName = this.textContent;
          var fileExtension = getFileExtension(docUrl).toLowerCase();
          
          // è®¾ç½®æ–‡æ¡£æ ‡é¢˜å’Œä¸‹è½½é“¾æ¥
          docTitle.textContent = docName;
          docDownloadLink.href = docUrl;
          docFallbackLink.href = docUrl;
          
          // æ ¹æ®æ–‡ä»¶ç±»å‹å†³å®šæ˜¯å¦åœ¨iframeä¸­é¢„è§ˆ
          if (previewableTypes.includes(fileExtension)) {
            // å¯¹äºPDFå’ŒOfficeæ–‡æ¡£ï¼Œä½¿ç”¨Googleæ–‡æ¡£æŸ¥çœ‹å™¨æˆ–ç›´æ¥æ˜¾ç¤º
            if (['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(fileExtension)) {
              // å¯¹äºOfficeæ–‡æ¡£ï¼Œä½¿ç”¨Googleæ–‡æ¡£æŸ¥çœ‹å™¨
              if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(fileExtension)) {
                docViewer.src = 'https://docs.google.com/gview?url=' + encodeURIComponent(window.location.origin + docUrl) + '&embedded=true';
              } else {
                // å¯¹äºPDFï¼Œç›´æ¥æ˜¾ç¤º
                docViewer.src = docUrl;
              }
              docViewer.style.display = 'block';
              docFallback.style.display = 'none';
            } else if (fileExtension === 'md') {
              // å¯¹äºMarkdownæ–‡ä»¶ï¼Œä½¿ç”¨ç®€åŒ–çš„æ ·å¼å¤„ç†
              var xhr = new XMLHttpRequest();
              xhr.open('GET', docUrl, true);
              xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                  // å…ˆåœ¨ä¸»ä½œç”¨åŸŸä¸­æ¸²æŸ“Markdown
                  var markdownContent = xhr.responseText;
                  var renderedContent = renderMarkdown(markdownContent);
                  
                  // åˆ›å»ºä¸€ä¸ªå¸¦æœ‰è‡ªå®šä¹‰æ ·å¼çš„HTMLé¡µé¢
                  var html = '<!DOCTYPE html>\n';
                  html += '<html>\n';
                  html += '<head>\n';
                  html += '  <meta charset="UTF-8">\n';
                  html += '  <title>' + docName + '</title>\n';
                  html += '  <style>\n';
                  html += '    body {\n';
                  html += '      background-color: white !important;\n';
                  html += '      color: #333333 !important;\n';
                  html += '      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n';
                  html += '      line-height: 1.6;\n';
                  html += '      margin: 0;\n';
                  html += '      padding: 20px;\n';
                  html += '    }\n';
                  html += '    h1, h2, h3, h4, h5, h6 {\n';
                  html += '      color: #2c3e50;\n';
                  html += '      margin-top: 1.5em;\n';
                  html += '      margin-bottom: 0.5em;\n';
                  html += '    }\n';
                  html += '    p {\n';
                  html += '      margin-bottom: 1em;\n';
                  html += '    }\n';
                  html += '    pre {\n';
                  html += '      background-color: #f5f5f5;\n';
                  html += '      border-radius: 4px;\n';
                  html += '      padding: 1em;\n';
                  html += '      overflow-x: auto;\n';
                  html += '      color: #333;\n';
                  html += '    }\n';
                  html += '    code {\n';
                  html += '      font-family: \'Courier New\', Courier, monospace;\n';
                  html += '      background-color: #f5f5f5;\n';
                  html += '      padding: 0.2em 0.4em;\n';
                  html += '      border-radius: 3px;\n';
                  html += '      color: #333;\n';
                  html += '    }\n';
                  html += '    a {\n';
                  html += '      color: #0066cc;\n';
                  html += '      text-decoration: none;\n';
                  html += '    }\n';
                  html += '    a:hover {\n';
                  html += '      text-decoration: underline;\n';
                  html += '    }\n';
                  html += '    ul, ol {\n';
                  html += '      margin-bottom: 1em;\n';
                  html += '      padding-left: 2em;\n';
                  html += '    }\n';
                  html += '    table {\n';
                  html += '      border-collapse: collapse;\n';
                  html += '      width: 100%;\n';
                  html += '      margin-bottom: 1em;\n';
                  html += '    }\n';
                  html += '    th, td {\n';
                  html += '      border: 1px solid #ddd;\n';
                  html += '      padding: 8px;\n';
                  html += '      text-align: left;\n';
                  html += '    }\n';
                  html += '    th {\n';
                  html += '      background-color: #f2f2f2;\n';
                  html += '      color: #333;\n';
                  html += '    }\n';
                  html += '  </style>\n';
                  html += '</head>\n';
                  html += '<body>\n';
                  html += '  <div class="markdown-content">' + renderedContent + '</div>\n';
                  html += '</body>\n';
                  html += '</html>';
                
                  // ä½¿ç”¨data URLåŠ è½½HTMLå†…å®¹
                  var blob = new Blob([html], { type: 'text/html' });
                  var url = URL.createObjectURL(blob);
                  docViewer.src = url;
                  docViewer.style.display = 'block';
                  docFallback.style.display = 'none';
                }
              };
              xhr.send();
              
              // åœ¨æ¨¡æ€æ¡†å…³é—­æ—¶é‡Šæ”¾blob URL
              docModal.one('hidden.bs.modal', function() {
                var currentSrc = docViewer.src;
                if (currentSrc.indexOf('blob:') === 0) {
                  URL.revokeObjectURL(currentSrc);
                  docViewer.src = '';
                }
              });
              
              docViewer.style.display = 'block';
              docFallback.style.display = 'none';
            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'txt'].indexOf(fileExtension) !== -1) {
              // å¯¹äºå›¾ç‰‡å’Œå…¶ä»–æ–‡æœ¬æ–‡ä»¶ï¼Œç›´æ¥æ˜¾ç¤º
              docViewer.src = docUrl;
              docViewer.style.display = 'block';
              docFallback.style.display = 'none';
            } else {
              // å¯¹äºä¸æ”¯æŒé¢„è§ˆçš„æ–‡ä»¶ç±»å‹ï¼Œæ˜¾ç¤ºä¸‹è½½æç¤º
              docViewer.style.display = 'none';
              docFallback.style.display = 'block';
            }
          } else {
            // å¯¹äºä¸æ”¯æŒé¢„è§ˆçš„æ–‡ä»¶ç±»å‹ï¼Œæ˜¾ç¤ºä¸‹è½½æç¤º
            docViewer.style.display = 'none';
            docFallback.style.display = 'block';
          }
          
          // è®¾ç½®iframeé«˜åº¦
          setIframeHeight();
          
          // æ‰“å¼€æ¨¡æ€æ¡†
          docModal.modal('show');
        });
      }
    }
    
    // æ¨¡æ€æ¡†å…³é—­æ—¶é‡ç½®æ–‡æ¡£æŸ¥çœ‹å™¨å’Œé‡Šæ”¾blob URL
    docModal.on('hidden.bs.modal', function() {
      var currentSrc = docViewer.src;
      if (currentSrc.indexOf('blob:') === 0) {
        URL.revokeObjectURL(currentSrc);
      }
      docViewer.src = '';
    });
    
    // æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶è®¾ç½®iframeé«˜åº¦
    docModal.on('shown.bs.modal', function() {
      setIframeHeight();
    });
    
    // çª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´iframeé«˜åº¦
    window.addEventListener('resize', function() {
      if (docModal.hasClass('show')) {
        setIframeHeight();
      }
    });
    
    // è·å–æ–‡ä»¶æ‰©å±•åçš„è¾…åŠ©å‡½æ•°
    function getFileExtension(url) {
      var match = url.match(/\.([^.]+)$/);
      return match ? match[1] : '';
    }
    
    // è®¾ç½®iframeé«˜åº¦çš„å‡½æ•°
    function setIframeHeight() {
      var modalBody = docModal.find('.modal-body');
      var modalBodyHeight = modalBody.height();
      docViewer.style.height = modalBodyHeight - 20 + 'px';
    }
  });
</script>
<div class="container mt-4">
    <div class="row">
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="col-md-12">
            {% if current_user.role == 'engineer' or (hasattr(current_user, 'role_detail') and current_user.role_detail == 'engineer') or (hasattr(current_user, 'role_level') and current_user.role_level == 3) %}
                <h1 class="text-center mb-6">å·¥ç¨‹å¸ˆæ•™å­¦èµ„æ–™</h1>
                <div class="alert alert-info mb-6 p-5 rounded-md">
                    <strong>æ¬¢è¿ï¼</strong> è¿™é‡Œæä¾›äº†å·¥ç¨‹å¸ˆæ‰€éœ€çš„æ‰€æœ‰æ•™å­¦èµ„æ–™å’ŒæŠ€æœ¯æ–‡æ¡£ã€‚
                </div>
            {% else %}
                <h1 class="text-center mb-6">è¯•å²—å‘˜å·¥èµ„æ–™</h1>
                <div class="alert alert-info mb-6 p-5 rounded-md">
                    <strong>æ¬¢è¿ï¼</strong> è¿™é‡Œæä¾›äº†è¯•å²—æœŸé—´æ‰€éœ€çš„æ‰€æœ‰èµ„æ–™ã€‚è¯·æŒ‰ç…§å­¦ä¹ è·¯å¾„å®Œæˆæ‰€æœ‰å†…å®¹ã€‚
                </div>
            {% endif %}
                
                {% if categories %}
                <div class="training-materials pl-0">
                    
                    <!-- æœç´¢è¡¨å• -->
                    <div class="card shadow-md p-4 mb-6 bg-white rounded-lg border border-gray-200 w-100">
                        <form action="{{ url_for('user.training_materials') }}" method="get" class="d-flex">
                            <input type="text" 
                                   name="search" 
                                   placeholder="æœç´¢èµ„æ–™åç§°ã€æè¿°æˆ–ç±»åˆ«..." 
                                   class="form-control flex-grow-1 mr-3 border-gray-300 rounded-md transition-all duration-200 hover:border-primary focus:border-primary focus:ring-2 focus:ring-primary/20 px-4 py-2"
                                   value="{{ request.args.get('search', '') }}">
                            <button type="submit" class="btn btn-primary px-6 py-2 rounded-md transition-all duration-200 hover:bg-primary/90 focus:ring-2 focus:ring-primary/30">
                                <i class="fas fa-search mr-2"></i>æœç´¢
                            </button>
                            {% if search_performed %}
                            <a href="{{ url_for('user.training_materials') }}" class="btn btn-secondary ml-2 px-4 py-2 rounded-md transition-all duration-200 hover:bg-secondary/90 focus:ring-2 focus:ring-secondary/30">
                                é‡ç½®
                            </a>
                            {% endif %}
                        </form>
                        {% if search_performed %}
                        <p class="text-sm text-gray-600 mt-3">æœç´¢ç»“æœ: "{{ request.args.get('search') }}" ({{ total_materials }} ä¸ªèµ„æ–™)</p>
                        {% else %}
                        <p class="text-sm text-gray-600 mt-3">å…± {{ total_materials }} ä¸ªèµ„æ–™</p>
                        {% endif %}
                    </div>
                    
                    {% if materials_by_category %}
                        {% for category in materials_by_category %}
                        <div class="card shadow-md p-6 mb-6 bg-white rounded-lg border border-gray-200 w-100" id="{{ category.name|lower|replace(' ', '-') }}">
                            {% if category_selected %}
                            <h3 class="text-secondary mb-4">
                                <i class="fas fa-folder mr-2"></i>å½“å‰æ˜¾ç¤º: {{ category.name }}
                            </h3>
                            {% else %}
                            <h3 class="text-secondary mb-4">
                                <i class="fas fa-folder mr-2"></i>{{ category.name }}
                            </h3>
                            {% endif %}
                            <!-- èµ„æ–™åˆ—è¡¨è¡¨æ ¼ -->
                            <div class="table-responsive">
                            <table class="table table-hover w-100">
                                <thead class="thead-light">
                                    <tr>
                                        <th scope="col" class="w-12">ç±»å‹</th>
                                        <th scope="col">èµ„æ–™åç§°</th>
                                        <th scope="col">æè¿°</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for material in category.materials %}
                                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                                        <td class="align-middle">
                                            {% if material.file_type == 'pdf' %}
                                            <i class="fas fa-file-pdf text-danger text-xl"></i>
                                            {% elif material.file_type in ['doc', 'docx'] %}
                                            <i class="fas fa-file-word text-blue text-xl"></i>
                                            {% elif material.file_type in ['xls', 'xlsx'] %}
                                            <i class="fas fa-file-excel text-green text-xl"></i>
                                            {% elif material.file_type in ['ppt', 'pptx'] %}
                                            <i class="fas fa-file-powerpoint text-orange text-xl"></i>
                                            {% elif material.file_type in ['mp4', 'avi', 'mov', 'wmv'] %}
                                            <i class="fas fa-video text-primary text-xl"></i>
                                            {% else %}
                                            <i class="fas fa-file text-gray text-xl"></i>
                                            {% endif %}
                                        </td>
                                        <td class="align-middle font-medium">
                                            {% if material.file_path %}
                                                {% if material.file_type in ['mp4', 'avi', 'mov', 'wmv'] %}
                                            <a href="#" class="text-blue-600 hover:underline video-link" data-video-url="{{ url_for('video.serve_video', filename=material.file_path.split('\\')[-1] if '\\' in material.file_path else material.file_path.split('/')[-1]) }}">{{ material.title }}</a>
                                            {% else %}
                                            <a href="/{{ material.file_path }}" class="text-blue-600 hover:underline">{{ material.title }}</a>
                                            {% endif %}
                                            {% else %}
                                            <span class="text-gray-500">{{ material.title }} <small>(æš‚æœªä¸Šä¼ èµ„æ–™)</small></span>
                                            {% endif %}
                                        </td>

                                        <td class="align-middle text-sm text-gray-600">
                                            {{ material.description or 'æ— æè¿°' }}
                                        </td>

                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="alert alert-info mt-4">
                        æš‚æ— èµ„æ–™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ ã€‚
                    </div>
                    {% endif %}
                </div>
            {% else %}
            <div class="alert alert-info">
                æš‚æ— èµ„æ–™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ ã€‚
            </div>
            {% endif %}
            
            {% if current_user.role == 'engineer' or (hasattr(current_user, 'role_detail') and current_user.role_detail == 'engineer') or (hasattr(current_user, 'role_level') and current_user.role_level == 3) %}
                <div class="text-center mt-6">
                    <a href="{{ url_for('user.user_panel') }}" class="btn btn-secondary">è¿”å›å·¥ç¨‹å¸ˆé¢æ¿</a>
                </div>
            {% else %}

                
                <div class="text-center mt-6">
                    <a href="{{ url_for('user.trainee_panel') }}" class="btn btn-secondary">è¿”å›è¯•å²—é¢æ¿</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // æ·»åŠ åˆ†ç±»ç­›é€‰åŠŸèƒ½çš„JavaScriptä»£ç 
    document.addEventListener('DOMContentLoaded', function() {
        // ä¾§è¾¹æ åˆ†ç±»é“¾æ¥å·²ç»é€šè¿‡hrefå±æ€§å®ç°äº†é¡µé¢åˆ‡æ¢ï¼Œä¸å†éœ€è¦JavaScriptäº‹ä»¶å¤„ç†
        
        // ç­›é€‰å¤é€‰æ¡†äº‹ä»¶
        const filterCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="filter-"]');
        filterCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // è¿™é‡Œå¯ä»¥æ·»åŠ ç­›é€‰é€»è¾‘ï¼Œæ ¹æ®é€‰ä¸­çš„å¤é€‰æ¡†æ˜¾ç¤ºæˆ–éšè—ä¸åŒç±»å‹çš„èµ„æ–™
                // ç›®å‰åªæ˜¯é¢„ç•™äº†ç­›é€‰åŠŸèƒ½çš„UIï¼Œå®é™…çš„ç­›é€‰é€»è¾‘éœ€è¦æ ¹æ®åç«¯æ•°æ®è¿›ä¸€æ­¥å®ç°
                console.log('ç­›é€‰é€‰é¡¹æ”¹å˜:', this.id, this.checked);
            });
        });
    });
</script>

<style>
/* å…¨å±€é‡ç½®å’ŒåŸºç¡€æ ·å¼ */
* {
    box-sizing: border-box;
}

/* ä¸»è¦å®¹å™¨æ ·å¼ */
.container {
    padding: 25px;
    max-width: 1200px;
    margin: 0 auto;
}

/* åŸ¹è®­èµ„æ–™ä¸»åŒºåŸŸ */
.training-materials {
    margin-top: 24px;
}

.training-materials a:hover {
    text-decoration: underline;
}

/* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
.table {
    width: 100%;
    margin-bottom: 1rem;
    background-color: transparent;
}

.table thead th {
    vertical-align: bottom;
    border-bottom: 2px solid #dee2e6;
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.table td, .table th {
    padding: 12px 15px;
    vertical-align: top;
    border-top: 1px solid #dee2e6;
}

.table-hover tbody tr:hover {
    color: #212529;
    background-color: rgba(0,0,0,0.04);
}

/* å“åº”å¼è¡¨æ ¼ */
.table-responsive {
    display: block;
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.table-responsive > .table {
    margin-bottom: 0;
}

/* å¾½ç« æ ·å¼ */
.badge {
    display: inline-block;
    padding: 0.25em 0.4em;
    font-size: 75%;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
}

.badge-danger {
    color: #fff;
    background-color: #dc3545;
}

.list-unstyled li:last-child {
    margin-bottom: 0;
}

.list-unstyled li:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* åˆ—è¡¨é¡¹å†…å…ƒç´ å¯¹é½ */
.list-unstyled li i {
    font-size: 24px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: #f8f9fa;
}

/* èµ„æ–™é¡¹æ ‡é¢˜æ ·å¼ */
.list-unstyled li a,
.list-unstyled li span.text-blue-600 {
    font-weight: 600;
    color: #0056b3;
    display: block;
    margin-bottom: 4px;
    font-size: 15px;
}

.list-unstyled li a:hover,
.list-unstyled li span.text-blue-600:hover {
    color: #003d80;
    text-decoration: underline;
}

/* å¾½ç« æ ·å¼ä¼˜åŒ– */
.list-unstyled li .badge {
    margin-top: 2px;
}

/* æè¿°æ–‡æœ¬æ ·å¼ */
.list-unstyled li p {
    margin-top: 8px;
    margin-bottom: 0;
    color: #6c757d;
    line-height: 1.5;
}

/* èµ„æ–™é¡¹æ ·å¼å¢å¼º */
.text-blue-600 {
    color: #0066cc;
    font-weight: 500;
    display: inline-block;
    max-width: calc(100% - 80px);
    white-space: normal;
    word-wrap: break-word;
}

.text-blue-600:hover {
    color: #0052a3;
}

/* å¾½ç« æ ·å¼ç¾åŒ– */
.badge {
    padding: 0.25em 0.5em;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
}

.badge-danger {
    background-color: #dc3545;
    color: white;
}

.badge-primary {
    background-color: #007bff;
    color: white;
}

.badge-secondary {
    background-color: #6c757d;
    color: white;
}

/* æŒ‰é’®æ ·å¼ç¾åŒ– */
.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    text-decoration: none;
    display: inline-block;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background-color: #5a6268;
    border-color: #545b62;
    color: white;
    transform: translateY(-1px);
}

/* è§†é¢‘é“¾æ¥æ ·å¼ä¼˜åŒ– */
.video-link {
    display: inline-block;
    position: relative;
}

.video-link::after {
    content: "ğŸ“¹ ç‚¹å‡»æ’­æ”¾è§†é¢‘";
    font-size: 11px;
    color: #6c757d;
    display: block;
    margin-top: 2px;
    white-space: nowrap;
}

/* è¿›åº¦æ¡æ ·å¼ */
.progress {
    height: 25px;
    border-radius: 12px;
    background-color: #e9ecef;
    overflow: hidden;
}

.progress-bar {
    border-radius: 12px;
    background-color: #28a745;
    transition: width 0.6s ease;
}

/* é—´è·ç±»å¢å¼º */
.mt-4 {
    margin-top: 24px !important;
}

.mb-4 {
    margin-bottom: 24px !important;
}

.mb-6 {
    margin-bottom: 36px !important;
}

.mt-6 {
    margin-top: 36px !important;
}

/* æ¬¢è¿ä¿¡æ¯æ ·å¼ */
.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
    padding: 16px;
    border-radius: 6px;
    margin-bottom: 24px;
}

/* æ ‡é¢˜æ ·å¼ */
.text-center {
    text-align: center;
}

.text-primary {
    color: #007bff;
    margin-bottom: 1.5rem;
    padding-left: 1rem;
}

.text-secondary {
    color: #6c757d;
    margin-bottom: 1rem;
    padding-left: 1rem;
}

/* åŸ¹è®­è·¯å¾„æ ·å¼ */
.list-decimal {
    padding-left: 20px;
    margin-left: 1rem;
}

.list-decimal li {
    margin-bottom: 8px;
    line-height: 1.5;
    padding-left: 0.5rem;
}

/* è­¦å‘Šæ¡†æ ·å¼ */
.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
    padding: 12px;
    border-radius: 4px;
}

/* å“åº”å¼å¸ƒå±€ */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
    
    .card {
        margin-bottom: 16px;
        border-radius: 12px;
    }
    
    .card-body {
        padding: 12px 16px;
    }
    
    .list-unstyled li {
        padding: 12px;
        margin-bottom: 10px;
    }
    
    .text-blue-600 {
        max-width: calc(100% - 70px);
    }
    
    .category-content {
        flex-direction: column;
    }
    
    .category-title {
        border-right: none;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
        margin-bottom: 0.5rem;
    }
}

/* è‡ªå®šä¹‰å¤é€‰æ¡†æ ·å¼ */
.custom-control-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.custom-control-input:focus {
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

/* è§†é¢‘å®¹å™¨æ ·å¼ */
.video-container {
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #000;
    padding: 0;
    width: 100%;
    overflow: hidden;
    min-height: 60vh;
}

.video-container video {
    max-width: 100%;
    max-height: calc(100vh - 150px); /* ç¡®ä¿è§†é¢‘ä¸ä¼šè¶…å‡ºå±å¹•é«˜åº¦ */
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
}

/* è§†é¢‘æ’­æ”¾å™¨æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– */
#videoPlayerModal .modal-body {
    min-height: 70vh;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

#videoPlayerModal .video-container {
    width: 100%;
    height: 100%;
    min-height: 60vh;
}

/* æ–‡æ¡£å®¹å™¨æ ·å¼ */
.document-container {
    width: 100%;
    height: 100%;
    position: relative;
    background-color: #ffffff;
}

.document-container iframe {
    display: none; /* é»˜è®¤éšè—ï¼Œç”±JavaScriptæ§åˆ¶æ˜¾ç¤º */
    border: none;
    background-color: #ffffff !important;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 100%;
    height: 100%;
    color: #333333 !important;
}

/* ä¸ºGoogleæ–‡æ¡£æŸ¥çœ‹å™¨å’Œæ‰€æœ‰iframeå†…å®¹æ·»åŠ å¼ºåˆ¶æ ·å¼ */
#documentViewerModal .modal-content {
    background-color: #ffffff;
    color: #333333;
}

#documentViewerModal .modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

#documentViewerModal .modal-title {
    color: #333333;
}

.document-container p {
    display: none; /* é»˜è®¤éšè—ï¼Œç”±JavaScriptæ§åˆ¶æ˜¾ç¤º */
}

/* æ–‡æ¡£æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– */
.modal-xl {
    max-width: 95%;
    width: 95%;
}

/* ç¡®ä¿æ–‡æ¡£æŸ¥çœ‹å™¨æ¨¡æ€æ¡†å†…å®¹åŒºåŸŸæœ‰è¶³å¤Ÿçš„é«˜åº¦ */
#documentViewerModal .modal-body {
    min-height: 70vh;
    padding: 15px;
    height: 70vh;
    display: block;
    background-color: #ffffff;
}

/* ç¡®ä¿æ–‡æ¡£å®¹å™¨èƒ½å¤Ÿå¡«å……æ•´ä¸ªæ¨¡æ€æ¡†å†…å®¹åŒºåŸŸ */
#documentViewerModal .document-container {
    width: 100%;
    height: 100%;
    background-color: #ffffff !important;
}

/* å¼ºåˆ¶æ‰€æœ‰æ–‡æ¡£æŸ¥çœ‹å™¨å†…å®¹ä½¿ç”¨ç™½è‰²èƒŒæ™¯å’Œæ·±ç°è‰²æ–‡å­— */
#documentViewer {
    background-color: #ffffff !important;
    color: #333333 !important;
}

/* ä¸ºGoogleæ–‡æ¡£æŸ¥çœ‹å™¨æ·»åŠ æ›´å¼ºçš„æ ·å¼è¦†ç›– */
#documentViewerModal iframe {
    background-color: #ffffff !important;
    color: #333333 !important;
}

/* ç¡®ä¿iframeå†…å®¹åŒºåŸŸçš„æ ·å¼æ­£ç¡® */
iframe#documentViewer {
    background-color: #ffffff !important;
    color: #333333 !important;
}

/* å¢å¼ºæ ·å¼ä¼˜å…ˆçº§ */
#documentViewerModal .modal-body .document-container iframe {
    background-color: #ffffff !important;
    color: #333333 !important;
}

/* ä¸‹è½½é“¾æ¥æ ·å¼å¢å¼º */
#documentDownloadLink {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
    text-decoration: none;
}

#documentDownloadLink:hover {
    background-color: #218838;
    border-color: #1e7e34;
}

@media (max-width: 576px) {
    .card-header button {
        font-size: 14px;
    }
    
    .text-blue-600 {
        max-width: calc(100% - 60px);
        font-size: 14px;
    }
    
    .list-unstyled li i {
        font-size: 16px;
        margin-right: 8px;
    }
    
    .badge {
        font-size: 11px;
        padding: 0.2em 0.4em;
    }
    
    /* ç§»åŠ¨è®¾å¤‡ä¸Šçš„è§†é¢‘å®¹å™¨æ ·å¼ */
    .video-container video {
        max-height: calc(100vh - 200px);
        width: 100%;
    }
    
    #videoPlayerModal .modal-body {
        min-height: 50vh;
    }
    
    #videoPlayerModal .video-container {
        min-height: 40vh;
    }
}

.category-tree {
    padding-left: 0;
}

.category-link {
    color: #495057;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
}

.category-link:hover {
    color: #007bff;
    text-decoration: none;
    transform: translateX(5px);
}

.category-link.bg-primary {
    color: white;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 992px) {
    .category-tree {
        max-height: 300px;
        overflow-y: auto;
    }
}

@media (max-width: 768px) {
    .sticky-top {
        position: static !important;
        top: 0 !important;
    }
    
    .category-tree {
        max-height: none;
    }
}
</style>

{% endblock %}